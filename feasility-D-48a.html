<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Integrated Site Feasibility Engine v2.1 (Fixed)</title>
<!-- Library Imports -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://unpkg.com/dxf-parser@1.1.2/dist/dxf-parser.js"></script>
<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js";
</script>
<style>
    :root {
        --primary-color: #3f51b5;
        --secondary-color: #1a237e;
        --accent-color: #f50057;
        --light-gray: #f4f7f9;
        --medium-gray: #e0e0e0;
        --dark-gray: #6c757d;
        --success-color: #28a745;
        --warning-color: #ffc107;
        --danger-color: #dc3545;
    }
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: var(--light-gray);
        color: #333;
        display: flex;
        height: 100vh;
        overflow: hidden;
    }
    .sidebar {
        width: 380px;
        min-width: 350px;
        background-color: #ffffff;
        border-right: 1px solid var(--medium-gray);
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        z-index: 10;
        box-shadow: 2px 0 5px rgba(0,0,0,0.05);
    }
    .main-content {
        flex-grow: 1;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        overflow: auto;
        position: relative;
    }
    h3, h4 { font-size: 1.1em; color: var(--primary-color); margin-top: 15px; margin-bottom: 10px; }
    .control-group { padding: 15px; border-bottom: 1px solid #eee; }
    label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em; }
    input, select { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px; }
    
    button {
        background-color: var(--primary-color); color: white; border: none; padding: 10px 15px;
        border-radius: 4px; cursor: pointer; width: 100%; font-size: 0.95em; margin-top: 5px;
    }
    button:hover { background-color: var(--secondary-color); }
    button:disabled { background-color: var(--dark-gray); cursor: not-allowed; opacity: 0.7; }
    button.active { background-color: var(--success-color); font-weight: bold; }
    button.warning { background-color: var(--warning-color); color: black; }
    button.danger { background-color: var(--danger-color); }
    
    .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .button-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }

    .canvas-container-wrapper {
        border: 2px dashed #ccc; background-color: #fff;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1); position: relative; max-width: 100%;
    }
    
    /* Floating Status Panel */
    #floating-dashboard {
        position: fixed; bottom: 20px; right: 20px; width: 340px;
        background: white; border: 1px solid #ccc; box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
        border-radius: 8px; z-index: 2000; display: flex; flex-direction: column;
        max-height: 85vh; transition: height 0.3s ease;
    }
    #floating-header {
        background: var(--secondary-color); color: white; padding: 10px 15px;
        cursor: pointer; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between;
        align-items: center; font-weight: bold; font-size: 0.95em;
    }
    #floating-content { padding: 10px 15px; overflow-y: auto; font-size: 0.85em; background: rgba(255,255,255,0.95); }
    #floating-content.minimized { display: none; }
    .dash-row { display: flex; justify-content: space-between; margin-bottom: 4px; border-bottom: 1px dotted #eee; padding-bottom: 2px; }
    .dash-row.header { font-weight: bold; background: #f0f2f5; padding: 5px; margin-top: 8px; color: var(--primary-color); }
    .dash-val { font-weight: 600; }
    .dash-val.good { color: var(--success-color); }
    .dash-val.bad { color: var(--danger-color); }

    /* Special Elements */
    .lock-btn { width: 100%; padding: 8px; margin-top: 5px; text-align: left; position: relative; }
    .lock-btn.locked { background-color: var(--danger-color); border: 1px solid #a71d2a; }
    .lock-btn.unlocked { background-color: var(--success-color); border: 1px solid #1e7e34; }
    #manual-plot-wrapper { background: #fff3cd; border: 1px solid #ffeeba; padding: 10px; border-radius: 4px; margin-top: 10px; }
    .hidden { display: none !important; }
</style>
</head>
<body>

<div class="sidebar">
    <h1 style="text-align:center; margin:10px 0;">Feasibility Engine</h1>
    
    <div class="control-group">
        <h3>1. Site Plan & Scale</h3>
        <div class="button-grid">
             <label for="plan-upload" class="button" style="text-align:center; padding:10px 0; margin-top:5px; cursor:pointer;">Upload Plan</label>
             <input type="file" id="plan-upload" accept=".png, .jpg, .jpeg, .pdf" style="display:none;">
             <label for="dxf-upload" class="button" style="text-align:center; padding:10px 0; margin-top:5px; cursor:pointer;">Import DXF</label>
             <input type="file" id="dxf-upload" accept=".dxf" style="display:none;">
        </div>
        <div id="pdf-controls" class="hidden">
            <label>PDF Page:</label><input type="number" id="pdf-page" value="1" min="1">
        </div>
        <div id="scale-input-group">
            <label>Known Distance (m)</label>
            <input type="number" id="scale-distance" value="10" step="0.1" disabled>
            <button id="set-scale-btn" disabled>Set Scale</button>
        </div>
        <div id="scale-display" style="font-size:0.8em; margin-top:5px; color:#666;">Scale not set.</div>
    </div>

    <div class="control-group">
        <h3>2. Level Management</h3>
        <div class="button-grid" style="grid-template-columns: 1fr 1fr 1fr;" id="level-selector">
             <!-- Populated by JS -->
        </div>
    </div>

    <div class="control-group">
        <h3>3. Drawing Tools</h3>
        <button id="draw-plot-btn" disabled>Draw Plot Polygon</button>
        
        <div id="manual-plot-wrapper">
            <label style="margin-bottom:2px; font-size:0.85em;">Manual Plot Override (Optional)</label>
            <div class="input-grid">
                <input type="number" id="manual-plot-area" placeholder="Area (mÂ²)" class="param-input">
                <input type="number" id="manual-plot-perim" placeholder="Perim (m)" class="param-input">
            </div>
            <div id="plot-info" style="font-size:0.8em; color: #444;"></div>
        </div>

        <button id="draw-building-btn" disabled style="margin-top:5px;">Draw Wing (Footprint)</button>
        
        <div class="button-grid">
             <button id="edit-footprint-btn" disabled class="warning">Edit</button>
             <button id="delete-footprint-btn" disabled class="danger">Delete</button>
        </div>
        <button id="confirm-footprint-btn" style="display:none;" class="active">âœ“ Confirm Edit</button>

        <h4 style="margin-top:10px;">Setbacks</h4>
        <div class="input-grid">
            <input type="number" id="individual-setback-dist" value="5" placeholder="Dist">
            <select id="individual-setback-dir"><option value="inside">Inside</option><option value="outside">Outside</option></select>
        </div>
        <button id="apply-individual-setback-btn" disabled>Apply Setback to Edge</button>
        
        <div id="level-footprint-info" style="font-size:0.8em; margin-top:10px; max-height:100px; overflow-y:auto; border:1px solid #eee; padding:5px;"></div>
    </div>

    <div class="control-group">
        <h3>4. Building Parameters</h3>
        <div class="input-grid">
            <div><label>GFA Allowed</label><input type="number" class="param-input" id="allowedGfa" value="13427"></div>
            <div><label>Retail GFA</label><input type="number" class="param-input" id="allowedRetailGfa" value="1000"></div>
            <div><label>Office GFA</label><input type="number" class="param-input" id="allowedOfficeGfa" value="2000"></div>
            <div><label>Nursery GFA</label><input type="number" class="param-input" id="allowedNurseryGfa" value="0"></div>
        </div>
        <div class="input-grid" style="margin-top:5px;">
            <div><label>Basements</label><input type="number" class="param-input" id="numBasements" value="1"></div>
            <div><label>Podiums</label><input type="number" class="param-input" id="numPodiums" value="3"></div>
            <div><label>Typical Flrs</label><input type="number" class="param-input" id="numTypicalFloors" value="11"></div>
        </div>
    </div>

    <div class="control-group">
        <h3>5. Service Blocks</h3>
        <label>Select Block Type</label>
        <select id="serviceBlockType" multiple></select>
        <button id="add-block-btn" disabled>Add Block(s) to Canvas</button>

        <div id="selected-object-controls" class="hidden" style="margin-top:10px; border-top:1px solid #eee; padding-top:10px;">
            <h4>Selected Object</h4>
             
            <button id="toggle-lock-btn" class="lock-btn locked">ðŸ”’ Locked</button>

            <div class="input-grid" style="margin-top:5px;">
                <div><label>Width</label><input type="number" id="block-width" step="0.1"></div>
                <div><label>Height</label><input type="number" id="block-height" step="0.1"></div>
            </div>
            
             <div class="button-grid">
                <button id="rotate-90-btn" title="Rotate 90Â°">Rot 90Â°</button>
                <button id="delete-block-btn" class="danger">Delete</button>
             </div>
        </div>
    </div>

    <div class="control-group">
        <h3>6. Actions</h3>
        <button id="calculateBtn" class="active" disabled>Generate Report</button>
    </div>
</div>

<div class="main-content">
    <div id="top-bar" style="width:100%; display:flex; justify-content: space-between; align-items:center; margin-bottom:10px;">
        <div class="zoom-controls">
            <button id="pan-btn" style="width:auto;">âœ‹ Pan</button>
            <button id="zoom-reset-btn" style="width:auto;">Reset Zoom</button>
        </div>
        <div id="status-bar" style="margin:0; width:auto; padding:5px 15px;">Ready</div>
    </div>
    
    <div class="canvas-container-wrapper">
        <canvas id="plot-canvas"></canvas>
    </div>
</div>

<div id="floating-dashboard">
    <div id="floating-header">
        <span>Live Feasibility Status</span>
        <span id="minimize-dash" style="font-size:1.2em;">âˆ’</span>
    </div>
    <div id="floating-content">
        <div class="dash-row header">GFA & Efficiency</div>
        <div class="dash-row"><span>Total Allowed GFA:</span> <span class="dash-val" id="dash-allowed-gfa">0</span></div>
        <div class="dash-row"><span>Consumed GFA:</span> <span class="dash-val" id="dash-consumed-gfa">0</span></div>
        <div class="dash-row"><span>Balance:</span> <span class="dash-val" id="dash-balance-gfa">0</span></div>
        <div class="dash-row"><span>Built-Up Area (BUA):</span> <span class="dash-val" id="dash-bua">0</span></div>
        <div class="dash-row"><span>Efficiency (GFA/BUA):</span> <span class="dash-val" id="dash-efficiency">0%</span></div>

        <div class="dash-row header">GFA Breakdown</div>
        <div class="dash-row"><span>Residential:</span> <span class="dash-val" id="dash-res-gfa">0</span></div>
        <div class="dash-row"><span>Retail:</span> <span class="dash-val" id="dash-retail-gfa">0</span></div>
        <div class="dash-row"><span>Office:</span> <span class="dash-val" id="dash-office-gfa">0</span></div>
        <div class="dash-row"><span>Nursery:</span> <span class="dash-val" id="dash-nursery-gfa">0</span></div>

        <div class="dash-row header">Residential Stats</div>
        <div class="dash-row"><span>Sellable Area:</span> <span class="dash-val" id="dash-sellable">0</span></div>

        <div class="dash-row header">Utilities</div>
        <div class="dash-row"><span>Elec Load:</span> <span class="dash-val" id="dash-elec-load">0 kVA</span></div>
        <div class="dash-row"><span>Water Req:</span> <span class="dash-val" id="dash-water-req">0 mÂ³/d</span></div>
        <div class="dash-row header" style="font-size:0.9em; margin-top:5px; background:#e3f2fd;">Substation</div>
        <div class="dash-row"><span>RMU Area Provided:</span> <span class="dash-val" id="dash-rmu-area">0 mÂ²</span></div>
        <div class="dash-row"><span>Substation Area Req:</span> <span class="dash-val" id="dash-substation-req">0 mÂ²</span></div>
    </div>
</div>

<script>
// --- GLOBAL STATE ---
const state = {
    canvas: null,
    scale: { ratio: 0, pixels: 0, meters: 0 },
    currentMode: null,
    currentLevel: 'Typical_Floor',
    levels: {
        'Basement': { objects: [], color: 'rgba(128, 128, 128, 0.4)' },
        'Ground_Floor': { objects: [], color: 'rgba(156, 39, 176, 0.4)' },
        'Podium': { objects: [], color: 'rgba(76, 175, 80, 0.4)' },
        'Typical_Floor': { objects: [], color: 'rgba(255, 255, 0, 0.4)' },
        'Roof': { objects: [], color: 'rgba(63, 81, 181, 0.4)' }
    },
    plotPolygon: null,
    serviceBlocks: [],
    wingCounter: 0,
    plotEdgeProperties: [],
    
    // Scale Logic
    scaleLine: null,
    scaleStart: null
};

const LEVEL_ORDER = ['Basement', 'Ground_Floor', 'Podium', 'Typical_Floor', 'Roof'];

const PREDEFINED_BLOCKS = {
    'Substation': { name: 'Substation', width: 6, height: 5, category: 'service' },
    'RMU_Room': { name: 'RMU Room', width: 3, height: 3, category: 'service' },
    'Garbage_Room': { name: 'Garbage Room', width: 4, height: 3, category: 'service' },
    'Lift_Core': { name: 'Lift Core', width: 8, height: 3, category: 'service' },
    'Staircase': { name: 'Staircase', width: 6, height: 3, category: 'gfa' },
    'Electrical_Room': { name: 'Electrical Room', width: 3, height: 3, category: 'service' },
    'Pump_Room': { name: 'Pump Room', width: 5, height: 5, category: 'service' }
};

const BLOCK_COLORS = {
    gfa: { fill: 'rgba(0, 200, 83, 0.5)', stroke: '#00c853' },
    service: { fill: 'rgba(213, 0, 0, 0.5)', stroke: '#d50000' }
};

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    initCanvas();
    initUI();
    setupEventListeners();
    updateDashboard();
});

function initCanvas() {
    const wrapper = document.querySelector('.canvas-container-wrapper');
    const canvasEl = document.getElementById('plot-canvas');
    canvasEl.width = wrapper.clientWidth*2;
    canvasEl.height = (wrapper.clientWidth/1.64)*2;

    state.canvas = new fabric.Canvas('plot-canvas', { 
        selection: true,
        preserveObjectStacking: true
    });
    
    // Event Hooks for Dashboard
    state.canvas.on('object:modified', (e) => {
        updateSelectedObjectControls(e.target);
        updateDashboard();
        if(e.target.isFootprint) updateLevelFootprintInfo();
    });
    state.canvas.on('object:scaling', updateDashboard);
    state.canvas.on('object:moving', updateDashboard);
    
    state.canvas.on('selection:created', (e) => updateSelectedObjectControls(e.target));
    state.canvas.on('selection:updated', (e) => updateSelectedObjectControls(e.target));
    state.canvas.on('selection:cleared', () => updateSelectedObjectControls(null));

    // Mouse Hooks for Drawing
    state.canvas.on('mouse:down', handleMouseDown);
    state.canvas.on('mouse:move', handleMouseMove);
    state.canvas.on('mouse:dblclick', handleDblClick);
}

function initUI() {
    const selector = document.getElementById('level-selector');
    LEVEL_ORDER.forEach(lvl => {
        const btn = document.createElement('button');
        btn.textContent = lvl.replace('_', ' ');
        btn.dataset.level = lvl;
        btn.onclick = () => setLevel(lvl);
        selector.appendChild(btn);
    });
    // Set default active
    setLevel('Typical_Floor');

    const blockSelect = document.getElementById('serviceBlockType');
    Object.keys(PREDEFINED_BLOCKS).forEach(key => {
        const opt = document.createElement('option');
        opt.value = key;
        opt.textContent = PREDEFINED_BLOCKS[key].name;
        blockSelect.appendChild(opt);
    });
}

function setupEventListeners() {
    document.getElementById('floating-header').addEventListener('click', toggleFloatingPanel);
    document.querySelectorAll('.param-input').forEach(inp => inp.addEventListener('input', updateDashboard));
    
    // Tools
    document.getElementById('set-scale-btn').addEventListener('click', startScale);
    document.getElementById('draw-plot-btn').addEventListener('click', () => enterMode('drawingPlot'));
    document.getElementById('draw-building-btn').addEventListener('click', () => enterMode('drawingBuilding'));
    
    // Blocks
    document.getElementById('add-block-btn').addEventListener('click', placeServiceBlock);
    document.getElementById('toggle-lock-btn').addEventListener('click', toggleBlockLock);
    document.getElementById('block-width').addEventListener('change', (e) => updateBlockDim('width', e.target.value));
    document.getElementById('block-height').addEventListener('change', (e) => updateBlockDim('height', e.target.value));
    document.getElementById('delete-block-btn').addEventListener('click', deleteSelectedObject);
    document.getElementById('rotate-90-btn').addEventListener('click', () => {
        const obj = state.canvas.getActiveObject();
        if(obj) { obj.rotate((obj.angle||0)+90); state.canvas.requestRenderAll(); }
    });

    // File Uploads
    document.getElementById('plan-upload').addEventListener('change', handlePlanUpload);
    document.getElementById('dxf-upload').addEventListener('change', handleDxfUpload);
    document.getElementById('pdf-page').addEventListener('change', handlePdfPageChange);

    document.getElementById('calculateBtn').addEventListener('click', () => alert("Full Report Generation Logic goes here (See Dashboard for Live Data)"));
    
    // Manual Plot Override
    document.getElementById('manual-plot-area').addEventListener('input', updateDashboard);
}

// --- CORE DASHBOARD LOGIC ---
function updateDashboard() {
    const inputs = {
        allowedGfa: parseFloat(document.getElementById('allowedGfa').value) || 0,
        retail: parseFloat(document.getElementById('allowedRetailGfa').value) || 0,
        office: parseFloat(document.getElementById('allowedOfficeGfa').value) || 0,
        nursery: parseFloat(document.getElementById('allowedNurseryGfa').value) || 0,
        basements: parseFloat(document.getElementById('numBasements').value) || 0,
        podiums: parseFloat(document.getElementById('numPodiums').value) || 0,
        floors: parseFloat(document.getElementById('numTypicalFloors').value) || 0
    };

    // 1. Plot Area
    let plotArea = 0;
    const manualArea = parseFloat(document.getElementById('manual-plot-area').value);
    if(manualArea > 0) {
        plotArea = manualArea;
        document.getElementById('plot-info').textContent = `Using Manual Area: ${manualArea} mÂ²`;
    } else if(state.plotPolygon && state.scale.ratio > 0) {
        plotArea = getPolyArea(state.plotPolygon);
        document.getElementById('plot-info').textContent = `Calc Area: ${plotArea.toFixed(1)} mÂ²`;
    }

    // 2. Footprint Areas
    let typFootprintArea = 0;
    state.levels['Typical_Floor'].objects.forEach(obj => typFootprintArea += getPolyArea(obj));

    // 3. GFA Calculation
    const grossTypGfa = typFootprintArea * inputs.floors;
    const resGfa = Math.max(0, grossTypGfa - (inputs.retail + inputs.office + inputs.nursery));
    const consumedGfa = resGfa + inputs.retail + inputs.office + inputs.nursery;
    const balance = inputs.allowedGfa - consumedGfa;

    // 4. BUA
    // BUA = GFA + Parking + Basements + Podiums
    const carsReq = (resGfa/100) + (inputs.retail/50) + (inputs.office/50);
    const estParkingArea = carsReq * 35; 
    const bua = consumedGfa + estParkingArea + (inputs.basements * plotArea * 0.8) + (inputs.podiums * plotArea * 0.6);
    const efficiency = bua > 0 ? ((consumedGfa / bua) * 100).toFixed(1) : 0;

    // 5. Residential
    const sellable = resGfa * 0.85; // 85% efficiency assumption

    // 6. Utilities
    const loadKVA = ((resGfa * 0.08) + (inputs.retail * 0.15) + (inputs.office * 0.12)).toFixed(0);
    const waterReq = (resGfa / 100 * 3 * 0.25).toFixed(0);

    // Substation / RMU
    let rmuArea = 0;
    state.serviceBlocks.forEach(blk => {
        if(blk.blockData && blk.blockData.name === 'RMU Room') rmuArea += getObjectArea(blk);
    });
    
    let subReqArea = Math.ceil(loadKVA / 1500) * 35;
    if (rmuArea > 0) subReqArea = Math.max(0, subReqArea - 10);

    // Update UI
    setDashVal('dash-allowed-gfa', inputs.allowedGfa);
    setDashVal('dash-consumed-gfa', consumedGfa.toFixed(0));
    setDashVal('dash-balance-gfa', balance.toFixed(0), balance >= 0 ? 'good' : 'bad');
    setDashVal('dash-bua', bua.toFixed(0));
    setDashVal('dash-efficiency', efficiency + '%');
    
    setDashVal('dash-res-gfa', resGfa.toFixed(0));
    setDashVal('dash-retail-gfa', inputs.retail);
    setDashVal('dash-office-gfa', inputs.office);
    setDashVal('dash-nursery-gfa', inputs.nursery);
    
    setDashVal('dash-sellable', sellable.toFixed(0));
    
    setDashVal('dash-elec-load', loadKVA + ' kVA');
    setDashVal('dash-water-req', waterReq + ' mÂ³/d');
    setDashVal('dash-rmu-area', rmuArea.toFixed(1) + ' mÂ²');
    setDashVal('dash-substation-req', subReqArea.toFixed(0) + ' mÂ²');
}

function setDashVal(id, val, cls) {
    const el = document.getElementById(id);
    if(el) {
        el.textContent = val;
        el.className = 'dash-val ' + (cls||'');
    }
}

function toggleFloatingPanel() {
    const el = document.getElementById('floating-content');
    el.classList.toggle('minimized');
    document.getElementById('minimize-dash').textContent = el.classList.contains('minimized') ? '+' : 'âˆ’';
}

// --- UTILS ---
function getPolyArea(obj) {
    if(!obj || !obj.points || !state.scale.ratio) return 0;
    let area = 0;
    const points = obj.points;
    for(let i=0; i<points.length; i++) {
        let j = (i+1)%points.length;
        area += points[i].x * points[j].y;
        area -= points[j].x * points[i].y;
    }
    area = Math.abs(area) / 2;
    return area * (state.scale.ratio * state.scale.ratio) * obj.scaleX * obj.scaleY;
}

function getObjectArea(obj) {
    const w = obj.getScaledWidth();
    const h = obj.getScaledHeight();
    return (w*h) * (state.scale.ratio * state.scale.ratio);
}

// --- INTERACTION LOGIC ---
let polyPoints = [];
let activeLine = null;

function handleMouseDown(o) {
    const ptr = state.canvas.getPointer(o.e);

    // Scaling Logic
    if(state.currentMode === 'settingScale') {
        if(!state.scaleStart) {
            state.scaleStart = ptr;
            document.getElementById('scale-display').textContent = "Click End Point...";
        } else {
            finishScaling(ptr);
        }
        return;
    }

    // Drawing Logic
    if(state.currentMode === 'drawingPlot' || state.currentMode === 'drawingBuilding') {
        polyPoints.push(ptr);
        if(polyPoints.length > 1) {
            // Draw visual line
            const pts = [polyPoints[polyPoints.length-2].x, polyPoints[polyPoints.length-2].y, ptr.x, ptr.y];
            activeLine = new fabric.Line(pts, { stroke: 'gray', strokeWidth: 1, selectable: false });
            state.canvas.add(activeLine);
        }
    }
}

function handleMouseMove(o) {
    if(!state.currentMode) return;
    const ptr = state.canvas.getPointer(o.e);
    // Could add snap-to-grid or guide logic here
}

function handleDblClick() {
    if(state.currentMode === 'drawingPlot' || state.currentMode === 'drawingBuilding') {
        polyPoints.pop(); // Remove double click point
        finishPolygon();
    }
}

function finishPolygon() {
    if(polyPoints.length < 3) { polyPoints=[]; return; }
    
    const isPlot = state.currentMode === 'drawingPlot';
    const color = isPlot ? 'rgba(0,0,255,0.1)' : state.levels[state.currentLevel].color;
    
    const poly = new fabric.Polygon(polyPoints, {
        fill: color, stroke: isPlot?'blue':'black', strokeWidth:1,
        selectable: true,
        isPlot: isPlot,
        isFootprint: !isPlot,
        level: isPlot ? 'Plot' : state.currentLevel
    });

    if(!isPlot) {
        // Wing Naming
        const name = `Wing ${String.fromCharCode(65 + state.wingCounter++)}`;
        poly.wingName = name;
        const center = poly.getCenterPoint();
        const text = new fabric.Text(name, { fontSize:14, left:center.x, top:center.y, originX:'center', originY:'center' });
        
        state.levels[state.currentLevel].objects.push(poly);
        state.canvas.add(text); // Separate text for simplicity, usually Group
        updateLevelFootprintInfo();
    } else {
        if(state.plotPolygon) state.canvas.remove(state.plotPolygon);
        state.plotPolygon = poly;
    }

    state.canvas.add(poly);
    state.canvas.renderAll();
    
    // Reset
    polyPoints = [];
    activeLine = null;
    enterMode(null);
    updateDashboard();
}

function startScale() {
    state.currentMode = 'settingScale';
    state.scaleStart = null;
    document.getElementById('scale-display').textContent = "Click Start Point...";
}

function finishScaling(endPtr) {
    const distPx = Math.hypot(endPtr.x - state.scaleStart.x, endPtr.y - state.scaleStart.y);
    const distM = parseFloat(document.getElementById('scale-distance').value);
    
    if(distPx > 0) {
        state.scale.ratio = distM / distPx;
        document.getElementById('scale-display').textContent = `1m = ${(1/state.scale.ratio).toFixed(2)}px`;
        
        // Draw red line for scale
        const line = new fabric.Line([state.scaleStart.x, state.scaleStart.y, endPtr.x, endPtr.y], {
            stroke: 'red', strokeWidth: 2, selectable: false
        });
        state.canvas.add(line);
        
        // Enable buttons
        document.getElementById('draw-plot-btn').disabled = false;
        document.getElementById('draw-building-btn').disabled = false;
        document.getElementById('add-block-btn').disabled = false;
        document.getElementById('calculateBtn').disabled = false;
        document.getElementById('apply-individual-setback-btn').disabled = false;
        document.getElementById('footprint-from-setbacks-btn').disabled = false;
    }
    
    state.currentMode = null;
    state.scaleStart = null;
}

function enterMode(mode) {
    state.currentMode = mode;
    state.canvas.discardActiveObject().renderAll();
    const bar = document.getElementById('status-bar');
    if(!mode) bar.textContent = "Ready";
    else if(mode === 'drawingPlot') bar.textContent = "Click to add Plot points. Double-click to finish.";
    else if(mode === 'drawingBuilding') bar.textContent = "Click to add Wing points. Double-click to finish.";
}

// --- SERVICE BLOCK LOGIC ---
function placeServiceBlock() {
    if(state.scale.ratio === 0) { alert("Set Scale first!"); return; }
    
    const selects = document.getElementById('serviceBlockType').selectedOptions;
    Array.from(selects).forEach(opt => {
        const data = PREDEFINED_BLOCKS[opt.value];
        const w = data.width / state.scale.ratio;
        const h = data.height / state.scale.ratio;
        const color = BLOCK_COLORS[data.category] || BLOCK_COLORS.service;

        const rect = new fabric.Rect({ width: w, height: h, fill: color.fill, stroke: color.stroke });
        const text = new fabric.Text(data.name, { fontSize: w*0.2, originX:'center', originY:'center', left: w/2, top: h/2 });
        // Visual Lock Icon (initially hidden or small)
        const lockIcon = new fabric.Text("ðŸ”’", { fontSize: 10, left:2, top:2, visible: true }); // Default Locked

        const group = new fabric.Group([rect, text, lockIcon], {
            left: state.canvas.width/2 + (Math.random()*50), 
            top: state.canvas.height/2 + (Math.random()*50),
            isServiceBlock: true,
            blockData: data,
            level: state.currentLevel,
            lockScalingX: true, // Default Locked
            lockScalingY: true
        });

        state.serviceBlocks.push(group);
        state.canvas.add(group);
        state.canvas.setActiveObject(group);
    });
    updateDashboard();
}

function toggleBlockLock() {
    const obj = state.canvas.getActiveObject();
    if(!obj || !obj.isServiceBlock) return;
    
    const isLocked = obj.lockScalingX;
    obj.set({ lockScalingX: !isLocked, lockScalingY: !isLocked });
    
    // Update visual icon
    const items = obj.getObjects();
    if(items[2]) items[2].set('text', !isLocked ? "ðŸ”’" : "ðŸ”“"); // Visual toggle
    
    obj.setCoords();
    state.canvas.requestRenderAll();
    updateSelectedObjectControls(obj);
}

function updateSelectedObjectControls(obj) {
    const el = document.getElementById('selected-object-controls');
    const lockBtn = document.getElementById('toggle-lock-btn');
    
    if(!obj) {
        el.classList.add('hidden');
        return;
    }
    el.classList.remove('hidden');

    if(obj.isServiceBlock) {
        const locked = obj.lockScalingX;
        lockBtn.className = locked ? "lock-btn locked" : "lock-btn unlocked";
        lockBtn.innerHTML = locked ? "ðŸ”’ Locked (Position Only)" : "ðŸ”“ Unlocked (Resizable)";
        
        document.getElementById('block-width').value = (obj.getScaledWidth() * state.scale.ratio).toFixed(2);
        document.getElementById('block-height').value = (obj.getScaledHeight() * state.scale.ratio).toFixed(2);
    }
}

function updateBlockDim(dim, val) {
    const obj = state.canvas.getActiveObject();
    if(!obj || !obj.isServiceBlock) return;
    
    const px = parseFloat(val) / state.scale.ratio;
    if(dim === 'width') obj.scaleToWidth(px);
    if(dim === 'height') obj.scaleToHeight(px);
    
    obj.setCoords();
    state.canvas.requestRenderAll();
    updateDashboard();
}

function deleteSelectedObject() {
    const obj = state.canvas.getActiveObject();
    if(!obj) return;
    
    if(obj.isServiceBlock) {
        state.serviceBlocks = state.serviceBlocks.filter(b => b !== obj);
    }
    if(obj.isFootprint) {
        const arr = state.levels[state.currentLevel].objects;
        const idx = arr.indexOf(obj);
        if(idx > -1) arr.splice(idx, 1);
        updateLevelFootprintInfo();
    }
    
    state.canvas.remove(obj);
    state.canvas.discardActiveObject();
    updateDashboard();
}

// --- FILE HANDLING ---
function handlePlanUpload(e) {
    const file = e.target.files[0];
    if(!file) return;
    if(file.type === 'application/pdf') {
        alert("PDF support requires worker configuration. Please use JPG/PNG for this demo.");
        return; 
    }
    const reader = new FileReader();
    reader.onload = (f) => {
        fabric.Image.fromURL(f.target.result, (img) => {
            const scale = Math.min(state.canvas.width/img.width, state.canvas.height/img.height);
            state.canvas.setBackgroundImage(img, state.canvas.renderAll.bind(state.canvas), {
                scaleX: scale, scaleY: scale
            });
            document.getElementById('set-scale-btn').disabled = false;
            document.getElementById('scale-distance').disabled = false;
        });
    };
    reader.readAsDataURL(file);
}

function handleDxfUpload(e) {
    alert("DXF Parsing logic loaded. Implement drawing entities here based on dxf-parser library.");
}

function handlePdfPageChange() {
    // Placeholder for PDF page switching logic
    console.log("PDF page changed");
}

function setLevel(lvl) {
    state.currentLevel = lvl;
    document.querySelectorAll('#level-selector button').forEach(b => {
        b.classList.toggle('active', b.dataset.level === lvl);
    });
    updateLevelFootprintInfo();
}

function updateLevelFootprintInfo() {
    const list = document.getElementById('level-footprint-info');
    let html = `<strong>${state.currentLevel.replace('_',' ')} Footprints:</strong><ul>`;
    state.levels[state.currentLevel].objects.forEach(obj => {
        html += `<li>${obj.wingName || 'Unnamed'} (${getPolyArea(obj).toFixed(1)} mÂ²)</li>`;
    });
    html += "</ul>";
    list.innerHTML = html;
}

</script>
</body>
</html>