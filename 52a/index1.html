Of course. I will implement the automatic setback calculation based on building height as described. This feature will automatically update the setback distances for plot edges classified as "Neighbor" or "Road" whenever you change the number of floors.

Here are the complete code changes across the necessary files:

### 1. `index.html` (UI Elements)
I've added a checkbox to enable/disable this feature and radio buttons within the "Individual Setback Controls" to classify each plot edge as either "Neighbor" or "Road".

```html
--- START OF FILE index.html ---


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feasibility Study Tool</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/dxf-parser@1.1.2/dist/dxf-parser.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>
    <div class="sidebar">
        <div class="control-group">
            <h2>1. Project Setup</h2>
             <label for="project-type-select">Project Type</label>
            <select id="project-type-select">
                <option value="Residential">Residential</option>
                <option value="Hotel">Hotel</option>
                <option value="School">School</option>
                <option value="LabourCamp">Labour Camp</option>
                <option value="Warehouse">Warehouse</option>
                <option value="Villa">Villa</option>
            </select>
            <label for="plan-upload" class="button">Upload Plan (PDF/Image)</label>
            <input type="file" id="plan-upload" accept=".pdf,image/*" style="display:none;">
            <div id="pdf-controls" style="display: none;">
                <label for="pdf-page">PDF Page:</label>
                <input type="number" id="pdf-page" value="1" min="1">
            </div>
             <label for="dxf-upload" class="button secondary-button">Upload DXF Overlay</label>
            <input type="file" id="dxf-upload" accept=".dxf" style="display:none;">
             <div id="dxf-controls" style="display:none;">
                <div class="input-with-button">
                    <input type="number" id="dxf-stroke-width" value="1" step="0.1" min="0.1">
                    <button id="zoom-to-dxf-btn">Zoom to DXF</button>
                </div>
                <div class="button-grid">
                    <button id="assign-dxf-plot-btn" class="warning">Use as Plot</button>
                    <button id="finalize-dxf-btn">Finalize as Guides</button>
                    <button id="delete-dxf-btn" class="danger">Delete DXF</button>
                </div>
            </div>
        </div>

        <div class="control-group">
            <h3>2. Scale & Units</h3>
            <div class="input-with-button">
                <input type="number" id="scale-distance" placeholder="Enter known distance in meters">
                <button id="set-scale-btn">Set Scale</button>
            </div>
            <div id="scale-display" class="info-box">Scale not set.</div>
             <button id="measure-tool-btn" class="secondary-button">Measure Distance</button>
        </div>

        <div class="control-group">
            <h3>3. Plot & Guides</h3>
             <button id="draw-plot-btn" class="secondary-button">Draw Plot Boundary</button>
             <button id="draw-guide-btn" class="secondary-button">Draw Guide Line</button>
            <div id="plot-info" class="info-box"></div>
        </div>

        <div class="control-group">
            <h3>4. Building Parameters</h3>
            <div class="input-grid">
                <div><label for="allowedGfa">Allowed GFA (m²)</label><input type="number" class="param-input" id="allowedGfa" value="100000"></div>
                <div><label for="allowedRetailGfa">Retail GFA (m²)</label><input type="number" class="param-input" id="allowedRetailGfa" value="0"></div>
                <div><label for="numBasements">No. of Basements</label><input type="number" class="param-input" id="numBasements" value="2"></div>
                <div><label for="numPodiums">No. of Podiums</label><input type="number" class="param-input" id="numPodiums" value="4"></div>
                <div><label for="numTypicalFloors">No. of Typical Floors</label><input type="number" class="param-input" id="numTypicalFloors" value="12"></div>
                <div><label for="allowedOfficeGfa">Office GFA (m²)</label><input type="number" class="param-input" id="allowedOfficeGfa" value="0"></div>
                 <div><label for="allowedNurseryGfa">Nursery GFA (m²)</label><input type="number" class="param-input" id="allowedNurseryGfa" value="0"></div>
                  <div><label for="numMezzanines">No. of Mezzanines</label><input type="number" class="param-input" id="numMezzanines" value="0"></div>
                   <div><label for="numHotelFloors">No. of Hotel Floors</label><input type="number" class="param-input" id="numHotelFloors" value="0"></div>
            </div>
             <div id="hotel-classification-wrapper" style="display:none;">
                <label for="hotel-star-rating">Hotel Classification</label>
                <div class="input-with-button">
                    <select id="hotel-star-rating">
                        <option value="1-star">1-Star</option>
                        <option value="3-star">3-Star</option>
                        <option value="4-star">4-Star</option>
                        <option value="5-star">5-Star</option>
                    </select>
                    <button id="view-hotel-reqs-btn">View Reqs</button>
                </div>
            </div>
             <div id="school-settings" style="display:none;">
                <h4>School Parameters</h4>
                <div class="input-grid">
                    <div><label for="num-classrooms">No. of Classrooms</label><input type="number" class="param-input" id="num-classrooms" value="32"></div>
                    <div><label for="admin-area">Admin Area (m²)</label><input type="number" class="param-input" id="admin-area" value="900"></div>
                </div>
            </div>
             <div id="labour-camp-settings" style="display:none;">
                <h4>Labour Camp Parameters</h4>
                 <div><label for="labours-per-room">Persons per Room</label><input type="number" class="param-input" id="labours-per-room" value="4"></div>
            </div>
        </div>

        <div class="control-group">
            <h3>5. Setback Controls</h3>
            <!-- MODIFICATION START: Added auto-setback toggle -->
            <label style="display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" class="param-input" id="auto-setback-toggle" checked style="width: auto; margin: 0;">
                <span>Auto-calculate Setbacks from Building Height</span>
            </label>
            <hr style="margin: 10px 0;">
            <!-- MODIFICATION END -->
            <button id="edit-setbacks-btn" class="secondary-button">Edit Individual Setbacks</button>
            <div id="individual-setback-controls">
                <h4>Selected Edge Settings</h4>
                <div class="input-grid">
                    <div>
                        <label for="individual-setback-dist">Distance (m)</label>
                        <input type="number" id="individual-setback-dist" step="0.1" value="5">
                    </div>
                    <div>
                        <label for="individual-setback-dir">Direction</label>
                        <select id="individual-setback-dir">
                            <option value="inside">Inside</option>
                            <option value="outside">Outside</option>
                        </select>
                    </div>
                </div>
                <!-- MODIFICATION START: Added edge type radio buttons -->
                <div style="margin-top: 10px;">
                    <label>Edge Type</label>
                    <div class="button-grid" style="font-size: 0.9em;">
                        <label><input type="radio" name="edge-type" value="neighbor" id="edge-type-neighbor" checked> Neighbor</label>
                        <label><input type="radio" name="edge-type" value="road" id="edge-type-road"> Road</label>
                    </div>
                </div>
                <!-- MODIFICATION END -->
                <div class="button-grid-2" style="margin-top: 10px;">
                    <button id="apply-individual-setback-btn">Apply to Selected</button>
                    <button id="clear-setback-selection-btn" class="secondary-button">Clear Selection</button>
                </div>
            </div>
        </div>
         <div class="control-group">
            <h3>6. Footprint Tools</h3>
             <div class="button-grid">
                 <button id="draw-building-btn">Draw Footprint</button>
                <button id="draw-linear-btn">Draw Linear Footprint</button>
                 <button id="footprint-from-setbacks-btn">Footprint from Setbacks</button>
                 <button id="footprint-from-plot-btn">Footprint from Plot</button>
            </div>
             <div class="input-with-button" style="margin-top: 10px;">
                <input type="number" id="corridor-width-input" value="1.8" step="0.1" placeholder="Corridor width (m)">
                <button id="draw-corridor-btn">Draw Corridor</button>
            </div>
             <div id="level-footprint-info"></div>
        </div>
        
         <div class="control-group">
            <h3>7. Service & Core Blocks</h3>
             <select id="serviceBlockType" multiple></select>
            <button id="add-block-btn" style="margin-top: 5px;">Place Selected Block(s)</button>
             <div id="service-block-list" style="margin-top: 10px; font-size: 0.85em; max-height: 200px; overflow-y: auto;"></div>
        </div>

        <div class="control-group">
             <h3>8. Composite Cores</h3>
             <div class="input-with-button">
                 <select id="composite-block-select"></select>
                <button id="place-composite-btn">Place</button>
            </div>
            <div class="button-grid-3">
                <button id="new-composite-btn" class="secondary-button">New</button>
                <button id="edit-composite-btn" class="secondary-button">Edit</button>
                <button id="delete-composite-btn" class="danger">Delete</button>
            </div>
        </div>
         <div id="program-specific-controls">
            <div class="control-group">
                <h3 id="mix-title">9. Apartment Mix</h3>
                <label for="scenarioSelect">Load Scenario</label>
                <select id="scenarioSelect"></select>
                
                <div style="display:flex; gap: 10px; margin: 10px 0;">
                    <label><input type="radio" name="apt-mode" value="auto" checked> Auto (from GFA)</label>
                    <label><input type="radio" name="apt-mode" value="manual"> Manual Count</label>
                </div>

                <div id="dist-sliders">
                    <div id="dist-sliders-container"></div>
                    <div style="text-align:right; font-weight:bold; margin-top:5px;">Total: <span id="mixTotal">100%</span></div>
                </div>
                <div id="manual-counts-container" style="display:none;"></div>
            </div>

            <div class="control-group">
                 <h3 id="unit-defs-title">10. Unit Definitions</h3>
                <div id="unit-cards-container"></div>
            </div>
        </div>
        
    </div>

    <div class="main-content">
        <div class="canvas-container-wrapper">
             <div class="zoom-controls">
                <button id="pan-btn">Pan (Space)</button>
                 <button id="select-tool-btn" class="active">Select (V)</button>
                <button id="zoom-in-btn">Zoom In (+)</button>
                <button id="zoom-out-btn">Zoom Out (-)</button>
                <button id="zoom-reset-btn">Reset Zoom</button>
                 <button id="toggle-visibility-btn">Show All Layers</button>
            </div>
            <div id="level-selector"></div>
            <canvas id="plot-canvas"></canvas>
            <canvas id="overlay-canvas"></canvas>
        </div>
        <div id="status-bar">Load a plan to begin.</div>
        <div id="report-container"></div>
    </div>
    <div id="floating-dashboard">
        <div id="floating-header">Feasibility Dashboard <span id="minimize-dash">−</span></div>
        <div id="floating-content">
             <div class="dash-row header"><span>GFA (m²)</span><span></span></div>
             <div class="dash-row"><span>Allowed</span><span id="dash-allowed-gfa" class="dash-val">0</span></div>
             <div class="dash-row"><span>Consumed</span><span id="dash-consumed-gfa" class="dash-val">0</span></div>
             <div class="dash-row"><span>Balance</span><span id="dash-balance-gfa" class="dash-val good">0</span></div>
              <div class="dash-row header"><span>BUA & Efficiency</span><span></span></div>
             <div class="dash-row"><span>Total BUA (m²)</span><span id="dash-bua" class="dash-val">0</span></div>
             <div class="dash-row"><span>Efficiency (Sellable/BUA)</span><span id="dash-efficiency" class="dash-val">0%</span></div>
              <div class="dash-row header"><span>GFA Breakdown (m²)</span><span></span></div>
             <div class="dash-row"><span>Residential</span><span id="dash-res-gfa" class="dash-val">0</span></div>
             <div class="dash-row"><span>Retail</span><span id="dash-retail-gfa" class="dash-val">0</span></div>
             <div class="dash-row"><span>Office</span><span id="dash-office-gfa" class="dash-val">0</span></div>
             <div class="dash-row"><span>Nursery</span><span id="dash-nursery-gfa" class="dash-val">0</span></div>
            <div class="dash-row header"><span>Residential Summary</span><span></span></div>
             <div class="dash-row"><span>Total Sellable Area (m²)</span><span id="dash-sellable" class="dash-val">0</span></div>
             <div id="dash-wing-details"></div>
            <div class="dash-row header"><span>Egress & Occupancy</span><span>Required / Provided</span></div>
            <div class="dash-row"><span>Total Occupancy</span><span id="dash-occupancy" class="dash-val">0</span></div>
            <div class="dash-row"><span>Lifts</span><span id="dash-lifts-info" class="dash-val">0 / 0</span></div>
            <div class="dash-row"><span>Staircases</span><span id="dash-stairs-info" class="dash-val">2 / 0</span></div>
             <div class="dash-row header"><span>Utilities</span><span></span></div>
            <div class="dash-row"><span>Garbage Bins (1.1m³)</span><span id="dash-garbage-req" class="dash-val">0</span></div>
            <div class="dash-row"><span>Water Tank</span><span id="dash-water-req" class="dash-val">0 m³/d</span></div>
            <div class="dash-row"><span>Electrical Load (est.)</span><span id="dash-elec-load" class="dash-val">0 kVA</span></div>
             <div class="dash-row"><span>RMU Area Provided</span><span id="dash-rmu-area" class="dash-val">0 m²</span></div>
             <div class="dash-row"><span>Substation Area Req.</span><span id="dash-substation-req" class="dash-val">0 m²</span></div>
        </div>
    </div>
     <div id="selected-object-controls">
         <h4>Selected: <span id="selected-object-name"></span></h4>
         <div id="rotation-control-wrapper">
             <label for="block-rotation">Rotation (°)</label>
             <input type="number" id="block-rotation" step="1">
         </div>
          <div id="dimension-controls-wrapper" class="input-grid">
            <div><label for="block-width">Width (m)</label><input type="number" id="block-width" step="0.1"></div>
            <div><label for="block-height">Height (m)</label><input type="number" id="block-height" step="0.1"></div>
        </div>
        <div id="substation-controls-wrapper" class="input-grid">
            <div><label for="substation-tcl">TCL (kW)</label><input type="number" id="substation-tcl" step="100"></div>
            <div><label for="substation-num-tx"># of Transformers</label><input type="number" id="substation-num-tx" step="1"></div>
        </div>
         <div id="category-controls-wrapper" style="display: none;">
            <label for="block-category-select">Category</label>
            <select id="block-category-select"></select>
        </div>
         <div class="button-grid-4">
            <button id="delete-block-btn" class="danger">Delete</button>
            <button id="flip-h-btn">Flip H</button>
            <button id="flip-v-btn">Flip V</button>
             <button id="rotate-90-btn">Rot 90°</button>
            <button id="align-block-btn">Align</button>
            <button id="move-level-btn">Move To</button>
            <button id="copy-to-levels-btn">Copy To</button>
            <button id="edit-group-btn" style="display: none;">Edit Group</button>
        </div>
         <button id="confirm-group-edit-btn" style="display: none;" class="warning">Confirm Group Edit</button>
    </div>
     <!-- Modals -->
    <div id="level-op-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="level-op-title"></h3>
            <div id="copy-level-content">
                <p>Select destination levels:</p>
                <div id="level-checklist" class="checkbox-grid"></div>
            </div>
            <div id="move-level-content">
                <label for="level-select-dropdown">Select new level:</label>
                <select id="level-select-dropdown"></select>
            </div>
             <div class="button-grid">
                 <button id="confirm-level-op-btn">Confirm</button>
                <button id="cancel-level-op-btn" class="secondary-button">Cancel</button>
            </div>
        </div>
    </div>
    <div id="hotel-req-modal" class="modal-overlay">
        <div class="modal-content wide">
            <h3 id="hotel-req-title">Hotel Requirements</h3>
            <div id="hotel-req-body"></div>
            <button id="close-hotel-req-btn" style="margin-top: 15px;">Close</button>
        </div>
    </div>
     <div id="threed-modal" class="modal-overlay">
        <div id="threed-modal-content">
            <canvas id="threed-canvas"></canvas>
            <button id="close-threed-modal" class="danger">X</button>
        </div>
    </div>
     <div id="edit-unit-modal" class="modal-overlay">
        <div class="modal-content" id="edit-unit-modal-content">
            <h3 id="edit-unit-title">Edit Unit</h3>
            <div id="edit-unit-body"></div>
            <div class="button-grid" style="margin-top: 20px;">
                <button id="save-unit-btn">Save Changes</button>
                <button id="cancel-unit-btn" class="secondary-button">Cancel</button>
            </div>
        </div>
    </div>
     <div id="edit-composite-modal" class="modal-overlay">
        <div class="modal-content" id="edit-composite-modal-content">
            <h3 id="edit-composite-title">Edit Composite Block</h3>
            <label for="composite-block-name-input">Name</label>
            <input type="text" id="composite-block-name-input">
             <label for="composite-default-level">Default Level</label>
            <select id="composite-default-level"></select>

            <h4>Sub-Blocks</h4>
            <div id="composite-sub-blocks-list"></div>
            <div id="add-sub-block-form">
                <select id="add-sub-block-select" style="flex-grow: 1; margin: 0;"></select>
                <button id="add-sub-block-btn" style="width: auto; margin: 0;">+ Add</button>
            </div>
            <div class="button-grid" style="margin-top: 20px;">
                <button id="save-composite-btn">Save Composite</button>
                <button id="cancel-composite-btn" class="secondary-button">Cancel</button>
            </div>
        </div>
    </div>
     <div id="area-statement-modal" class="modal-overlay">
        <div class="modal-content wide">
            <h3>Manual Area Statement</h3>
            <p style="font-size:0.8em; color:#555;">Manually override calculated areas per level. Any manual entry will be highlighted and used instead of the calculated value.</p>
            <div id="area-statement-body"></div>
            <hr>
            <h4>Add Manual Entry</h4>
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 10px; align-items: flex-end;">
                 <select id="manual-area-level"></select>
                 <select id="manual-area-type">
                    <option value="sellableGfa">Sellable GFA</option>
                    <option value="commonGfa">Common GFA</option>
                     <option value="corridor">Corridor (adds to Common)</option>
                    <option value="service">Service Area</option>
                    <option value="parking">Parking Area</option>
                    <option value="balconyTerrace">Balcony/Terrace</option>
                 </select>
                <input type="number" id="manual-area-value" placeholder="Area in m²">
                <button id="add-manual-area-btn" style="width:auto;">+ Add</button>
            </div>

            <div class="button-grid-3" style="margin-top: 20px;">
                <button id="save-area-statement-btn">Save & Close</button>
                <button id="reset-area-overrides-btn" class="warning">Reset All Overrides</button>
                <button id="close-area-statement-btn" class="secondary-button">Cancel</button>
            </div>
        </div>
    </div>
    <script type="module" src="main.js"></script>
</body>
</html>
```

### 2. `config.js`

This file is now updated with the setback rules.

```javascript
//--- START OF FILE config.js ---

// MODULE 1: CONFIG & PROGRAM DATA (config.js equivalent)
// =====================================================================
import { VILLA_PROGRAM } from './villaProgram.js';

// --- MODIFICATION START: Added setback rules based on the provided table ---
export const SETBACK_RULES = [
    // Based on total number of floors ABOVE ground level.
    // Ground floor itself is considered floor #1 in this count.
    { minFloors: 0, maxFloors: 0, neighbor: 0, road: 0 },    // Basement only
    { minFloors: 1, maxFloors: 4, neighbor: 3, road: 0 },    // G, G+1, G+2, G+3
    { minFloors: 5, maxFloors: 5, neighbor: 3.75, road: 0 }, // G+4
    { minFloors: 6, maxFloors: 6, neighbor: 4.50, road: 0 }, // G+5
    { minFloors: 7, maxFloors: 7, neighbor: 5.25, road: 0 }, // G+6
    { minFloors: 8, maxFloors: 8, neighbor: 6.00, road: 0 }, // G+7
    { minFloors: 9, maxFloors: 9, neighbor: 6.75, road: 0 }, // G+8
    { minFloors: 10, maxFloors: 10, neighbor: 7.50, road: 0 },// G+9
    { minFloors: 11, maxFloors: Infinity, neighbor: 7.50, road: 0 } // G+10 and above
];
// --- MODIFICATION END ---

export function calculateUnitDimensions(unit) {
    if (!unit.layout || unit.layout.length === 0) {
        unit.frontage = 0; unit.depth = 0; unit.area = 0; return;
    }
    const bounds = unit.layout.reduce((acc, room) => ({
        minX: Math.min(acc.minX, room.x), minY: Math.min(acc.minY, room.y),
        maxX: Math.max(acc.maxX, room.x + room.w), maxY: Math.max(acc.maxY, room.y + room.h)
    }), { minX: Infinity, minY: Infinity, maxX: -Infinity, maxY: -Infinity });
    unit.frontage = bounds.maxX - bounds.minX;
    unit.depth = bounds.maxY - bounds.minY;
    unit.area = unit.layout.reduce((sum, room) => sum + (room.w * room.h), 0);
}

export const LEVEL_DEFINITIONS = {
    'Basement': { objects: [], color: 'rgba(128, 128, 128, 0.4)', countKey: 'numBasements' },
    'Basement_Last': { objects: [], color: 'rgba(100, 100, 100, 0.4)', countKey: null },
    'Ground_Floor': { objects: [], color: 'rgba(156, 39, 176, 0.4)', countKey: null },
    'Mezzanine': { objects: [], color: 'rgba(126, 87, 194, 0.4)', countKey: 'numMezzanines' },
    'Retail': { objects: [], color: 'rgba(255, 152, 0, 0.8)', countKey: null },
    'Supermarket': { objects: [], color: 'rgba(205, 220, 57, 0.4)', countKey: null },
    'Podium': { objects: [], color: 'rgba(76, 175, 80, 0.4)', countKey: 'numPodiums' },
    'Podium_Last': { objects: [], color: 'rgba(66, 155, 70, 0.4)', countKey: null },
    'Office': { objects: [], color: 'rgba(3, 169, 244, 0.4)', countKey: null },
    'Commercial': { objects: [], color: 'rgba(233, 30, 99, 0.4)', countKey: null },
    'Typical_Floor': { objects: [], color: 'rgba(255, 255, 0, 0.4)', countKey: 'numTypicalFloors' },
    'Hotel': { objects: [], color: 'rgba(159, 100, 255, 0.4)', countKey: 'numHotelFloors' },
    'LabourCamp': { objects: [], color: 'rgba(255, 87, 34, 0.4)', countKey: null },
    'Warehouse': { objects: [], color: 'rgba(96, 125, 139, 0.4)', countKey: null },
    'School': { objects: [], color: 'rgba(0, 150, 136, 0.4)', countKey: null },
    'Roof': { objects: [], color: 'rgba(63, 81, 181, 0.4)', countKey: null }
};
export const LEVEL_ORDER = [
    'Basement', 'Basement_Last', 'Ground_Floor', 'Mezzanine', 'Retail', 'Supermarket', 
    'Podium', 'Podium_Last', 'Office', 'Commercial', 'Typical_Floor', 'Hotel', 'LabourCamp', 'Warehouse', 'School', 'Roof'
];
export const LEVEL_HEIGHTS = {
    Basement: 3.5, Basement_Last: 3.5, Ground_Floor: 8.5, Mezzanine: 3.0, Retail: 4.5, Supermarket: 5.0,
    Podium: 3.2, Podium_Last: 3.5, Office: 3.5, Commercial: 4.0, Typical_Floor: 3.5, Hotel: 3.5,  LabourCamp: 3.5, Warehouse: 10.0, School: 4.0, Roof: 1.0, default: 3.5
};
export const BLOCK_CATEGORY_COLORS = {
    gfa: { fill: 'rgba(0, 200, 83, 0.5)', stroke: '#00c853' },
    service: { fill: 'rgba(213, 0, 0, 0.5)', stroke: '#d50000' },
    builtup: { fill: 'rgba(41, 121, 255, 0.5)', stroke: '#2979ff' },
    void_area: { fill: 'rgba(0, 121, 255, 0.5)', stroke: '#2979ff' },
    default: { fill: 'rgba(128, 0, 128, 0.5)', stroke: '#800080' }
};

export const HOTEL_PROGRAM = {
    title: "Room & Suite Mix", unitDefsTitle: "Key Definitions",
    unitTypes: [
        { key: "standard_key", type: "Standard Key", area: 35, color: 'rgba(59, 130, 246, 0.7)', mix: 90, layout: [{ name: 'Room', x: 0, y: 0, w: 5, h: 7 }] },
        { key: "suite_key", type: "Suite Key", area: 70, color: 'rgba(16, 185, 129, 0.7)', mix: 10, layout: [{ name: 'Living', x: 0, y: 0, w: 5, h: 7 }, { name: 'Bed', x: 5, y: 0, w: 5, h: 7 }] }
    ],
    scenarios: [ { name: "1. Standard Hotel", mix: [90, 10] }, { name: "2. Boutique Hotel", mix: [70, 30] }, { name: "3. Business Hotel", mix: [95, 5] } ],
    parkingRule: function(unit) { if (unit.key === 'suite_key') return 0.5; return 0.2; },
    getParkingRuleDescription: function(unit) { if (unit.key === 'suite_key') return '1 per 2 suites'; return '1 per 5 rooms'; },
    calculateUnitDimensions,
};
HOTEL_PROGRAM.unitTypes.forEach(unit => {
    if (unit.key === 'standard_key') { unit.frontage = 5; unit.depth = 7; }
    if (unit.key === 'suite_key') { unit.frontage = 10; unit.depth = 7; }
});

export const RESIDENTIAL_PROGRAM = {
    title: "Apartment Mix", unitDefsTitle: "Unit Definitions",
    unitTypes: [
        {key:"studio", type:"Studio", balconyMultiplier:1.8, balconyCoverage: 80, layout:[{name:'Living/Bed', x:0, y:0, w:4, h:8}], color:'rgba(251, 191, 36, 0.7)', mix:10, occupancyLoad:1.5 },
        {key:"1bhk", type:"1 Bedroom", balconyMultiplier:1.8, balconyCoverage: 80, layout:[{name:'Living', x:0, y:0, w:4, h:8},{name:'Bed', x:4, y:0, w:4, h:8}], color:'rgba(59, 130, 246, 0.7)', mix:40, occupancyLoad:1.8 },
        {key:"1bhk_study", type:"1 Bed + Study", balconyMultiplier:1.8, balconyCoverage: 80, layout:[ { name: 'Living', x: 0, y: 0, w: 4.5, h: 8 }, { name: 'Bed', x: 4.5, y: 0, w: 4, h: 8 }, { name: 'Study', x: 8.5, y: 0, w: 3, h: 5 }, ], color: 'rgba(23, 162, 184, 0.7)', mix: 0, occupancyLoad: 2 },
        {key:"2bhk", type:"2 Bedroom", balconyMultiplier:1.8, balconyCoverage: 80, layout:[{name:'Living', x:0, y:0, w:4, h:8},{name:'Bed 1', x:4, y:0, w:4, h:8},{name:'Bed 2', x:8, y:0, w:4, h:8}], color:'rgba(16, 185, 129, 0.7)', mix:40, occupancyLoad:3 },
        {key:"3bhk", type:"3 Bedroom", balconyMultiplier:1.8, balconyCoverage: 80, layout:[{name:'Living', x:0, y:0, w:5.5, h:8},{name:'Bed 1', x:5.5, y:0, w:4, h:8},{name:'Bed 2', x:9.5, y:0, w:4, h:8},{name:'Bed 3', x:13.5, y:0, w:5, h:8}], color:'rgba(239, 68, 68, 0.7)', mix:10, occupancyLoad:4 },
        {key:"4bhk", type:"4 Bedroom", balconyMultiplier:1.8, balconyCoverage: 80, layout:[{name:'Living', x:0, y:0, w:6, h:8},{name:'Bed 1', x:6, y:0, w:4.5, h:8},{name:'Bed 2', x:10.5, y:0, w:4.5, h:8}, {name:'Bed 3', x:15, y:0, w:4, h:8}, {name:'Bed 4', x:19, y:0, w:3.5, h:8}], color:'rgba(139, 92, 246, 0.7)', mix:0, occupancyLoad:5 },
        {key:"5bhk", type:"5 Bedroom", balconyMultiplier:1.8, balconyCoverage: 80, layout:[{name:'Living', x:0, y:0, w:7, h:8},{name:'Bed 1', x:7, y:0, w:5, h:8},{name:'Bed 2', x:12, y:0, w:4.5, h:8},{name:'Bed 3', x:16.5, y:0, w:4, h:8},{name:'Bed 4', x:20.5, y:0, w:3.5, h:8}, {name:'Bed 5', x:24, y:0, w:2.5, h:8}], color:'rgba(236, 72, 153, 0.7)', mix:0, occupancyLoad:6 },
        {key:"duplex_3bhk", type:"Duplex (3 Bed)", balconyMultiplier:2.0, balconyCoverage: 90, layout:[ { name: 'Living', x: 0, y: 0, w: 6, h: 10 }, { name: 'Kitchen', x: 6, y: 6, w: 4, h: 4 }, { name: 'Bed 1', x: 6, y: 0, w: 4, h: 6 }, { name: 'Bed 2', x: 10, y: 0, w: 5, h: 5 }, { name: 'Bed 3', x: 10, y: 5, w: 5, h: 5 }, { name: 'Stair', x: 0, y: 8, w: 2, h: 2 }, ], color: 'rgba(108, 117, 125, 0.7)', mix: 0, occupancyLoad: 4.5 },
        {key:"penthouse_4bhk", type:"Penthouse (4 Bed)", balconyMultiplier:2.5, balconyCoverage: 100, layout:[ { name: 'Living', x: 0, y: 0, w: 8, h: 12 }, { name: 'M. Bed', x: 8, y: 0, w: 6, h: 8 }, { name: 'Bed 2', x: 14, y: 0, w: 5, h: 6 }, { name: 'Bed 3', x: 14, y: 6, w: 5, h: 6 }, { name: 'Terrace', x: 19, y: 0, w: 4, h: 12 }, { name: 'Kitchen', x: 8, y: 8, w: 6, h: 4 }, ], color: 'rgba(253, 126, 20, 0.7)', mix: 0, occupancyLoad: 6 }
    ],
    scenarios: [
        {name:"1. Balanced Mix",mix:[10,40,0,40,10,0,0,0,0]},
        {name:"2. Budget Friendly",mix:[40,40,0,15,5,0,0,0,0]},
        {name:"3. Family Oriented",mix:[5,15,0,50,30,0,0,0,0]},
        {name:"4. Luxury Focus",mix:[0,5,0,20,40,25,0,10,0]},
        {name:"5. Compact Living",mix:[50,30,10,10,0,0,0,0,0]},
        {name:"6. Luxury High-End", mix:[0,0,5,10,20,25,10,10,20]}
    ],
    parkingRule: function(unit) {
        if (unit.key.includes('penthouse') || unit.key.includes('5bhk')) return 3;
        if (unit.key.includes('duplex') || unit.key.includes('4bhk') || unit.key.includes('3bhk')) return 2;
        if (unit.key.includes('2bhk') && unit.area > 140) return 2;
        return 1;
    },
    getParkingRuleDescription: function(unit) {
        const bays = this.parkingRule(unit);
        let reason = `${bays} per unit`;
        if (unit.key.includes('2bhk') && unit.area > 140) { reason += ' (>140m²)'; }
        return reason;
    },
    liftOccupancyRanges: [0, 201, 301, 401, 501, 601, 701, 801, 901, 1001],
    liftMatrix: [[1,5,1,1,2,2,0,0,0,0,0,0],[6,10,2,2,2,2,3,3,3,0,0,0],[11,15,2,2,2,3,3,3,4,4,4,5],[16,20,2,2,3,3,3,4,4,4,5,5],[21,25,2,3,3,3,4,4,4,5,5,6],[26,30,3,3,3,3,4,4,5,5,5,6],[31,35,3,3,3,4,4,5,5,5,6,6]],
    calculateLifts: function(totalOccupancyLoad, numFloors) { if (numFloors <= 0 || totalOccupancyLoad <= 0) return 0; let floorConfigRow = this.liftMatrix.find(row => numFloors >= row[0] && numFloors <= row[1]); if (!floorConfigRow) { floorConfigRow = this.liftMatrix[this.liftMatrix.length - 1]; } let occupancyColIndex = 0; for (let i = this.liftOccupancyRanges.length - 1; i >= 0; i--) { if (totalOccupancyLoad >= this.liftOccupancyRanges[i]) { occupancyColIndex = i; break; } } const liftCountIndex = occupancyColIndex + 2; return floorConfigRow[liftCountIndex] || floorConfigRow[floorConfigRow.length - 1]; },
    
    // NEW: Staircase requirement data from PDF
    staircaseOccupancyRules: [
        { min: 0, max: 499, exits: 2 },
        { min: 500, max: 1000, exits: 3 },
        { min: 1001, max: Infinity, exits: 4 }
    ],
    calculateStaircases: function(totalOccupancyLoad) {
        if (totalOccupancyLoad <= 0) return 2; // Baseline for any building
        const rule = this.staircaseOccupancyRules.find(range => 
            totalOccupancyLoad >= range.min && totalOccupancyLoad <= range.max
        );
        return rule ? rule.exits : 2; // Default to 2 if something goes wrong
    },
    
    calculateUnitDimensions,
};
RESIDENTIAL_PROGRAM.unitTypes.forEach(calculateUnitDimensions);

export const SCHOOL_PROGRAM = {
    title: "School Program", unitDefsTitle: "Room Definitions",
    unitTypes: [ // These are representations, not for layout mix. `num` is from the image.
        { key: "classroom_g7_12", type: "Classroom (G7-12)", area: 60, color: 'rgba(59, 130, 246, 0.7)', num: 26, layout: [{ name: 'Class', x: 0, y: 0, w: 7.5, h: 8 }] },
        { key: "classroom_g13", type: "Classroom (G13)", area: 65, color: 'rgba(16, 185, 129, 0.7)', num: 6, layout: [{ name: 'Class', x: 0, y: 0, w: 8, h: 8.125 }] },
    ],
    scenarios: [ { name: "Standard School", mix: [] } ], // Mix not applicable here
    parkingRules: {
        carPerClassroom: 1,
        carPerAdminSqm: 50, // Corrected from image typo: 900sqm / 18 cars = 50sqm/car
        busPerClassroom: 1/3,
        accessibleRatio: 1/50, // 1 for every 50 -> 2 required for 50+50 parking
    },
    playAreaMultiplier: 2.0, // 2 x Classroom Area
    coveredPlayAreaRatio: 0.5, // 50% of total
    garbageKgPer100Sqm: 12,
    getParkingRuleDescription: () => 'School Specific Rules', // Placeholder
    calculateUnitDimensions,
};
SCHOOL_PROGRAM.unitTypes.forEach(calculateUnitDimensions);


export const LABOUR_CAMP_PROGRAM = {
    title: "Room Mix", unitDefsTitle: "Room Definitions",
    unitTypes: [
        {key:"labor_room", type:"Labor Room (4p)", layout:[{name:'Room', x:0, y:0, w:4, h:5}], color:'rgba(251, 191, 36, 0.7)', mix:70},
        {key:"supervisor_room", type:"Supervisor Room", layout:[{name:'Room', x:0, y:0, w:5, h:5}], color:'rgba(59, 130, 246, 0.7)', mix:10},
    ],
    scenarios: [ {name:"Standard Camp",mix:[90,10]} ],
    calculateUnitDimensions,
};
LABOUR_CAMP_PROGRAM.unitTypes.forEach(calculateUnitDimensions);

export const PROJECT_PROGRAMS = {
    'Residential': RESIDENTIAL_PROGRAM, 
    'Hotel': HOTEL_PROGRAM, 
    'School': SCHOOL_PROGRAM, 
    'LabourCamp': LABOUR_CAMP_PROGRAM,
    'Villa': VILLA_PROGRAM,
    'Warehouse': null
};

export const AREA_STATEMENT_DATA = [
    { name: "Comm. Staircase (Basement)", key: "Comm_Staircase_Basement_6_3", level: "Basement", type: "gfa", w: 6, h: 3, role: 'staircase' },
    { name: "Corridor (Basement)", key: "Corridor_Basement_2.4_2.4", level: "Basement", type: "gfa", w: 2.4, h: 2.4 },
    { name: "Lift (Basement)", key: "Lift_Basement_2.4_2.4", level: "Basement", type: "gfa", w: 2.4, h: 2.4 },
    { name: "Pump Room for ETS", key: "Pump_Room_for_ETS_5_5", level: "Basement", type: "service", w: 5, h: 5 },
    { name: "Water Tank", key: "Water_Tank_3_10", level: "Basement", type: "service", w: 3, h: 10 },
    { name: "BTU Meter Room", key: "BTU_Meter_Room_2.5_2.5", level: "Ground_Floor", type: "service", w: 2.5, h: 2.5 },
    { name: "Comm_Staircase_GF", key: "Comm_Staircase_GF_6_3", level: "Ground_Floor", type: "gfa", w: 6, h: 3, role: 'staircase' },
    { name: "Control Room", key: "Control_Room_19_1", level: "Ground_Floor", type: "service", w: 19, h: 1 },
    { name: "Corridor (GF)", key: "Corridor_GF_6.5_1.8", level: "Ground_Floor", type: "gfa", w: 6.5, h: 1.8 },
    { name: "ETS Room", key: "ETS_Room_9_9", level: "Ground_Floor", type: "service", w: 9, h: 9 },
    { name: "Electrical Room", key: "Electrical_Room_3_3", level: "Ground_Floor", type: "service", w: 3, h: 3 },
    { name: "Entrance Lobby", key: "Entrance_Lobby_8_12", level: "Ground_Floor", type: "gfa", w: 8, h: 12 },
    { name: "GSM Room", key: "GSM_Room_3_3", level: "Ground_Floor", type: "service", w: 3, h: 3 },
    { name: "Garbage Room", key: "Garbage_Room_8_1", level: "Ground_Floor", type: "service", w: 8, h: 1 },
    { name: "Generator Room", key: "Generator_Room_7_8", level: "Ground_Floor", type: "service", w: 7, h: 8 },
    { name: "LV Room", key: "LV_Room_5.1_8.6", level: "Ground_Floor", type: "service", w: 5.1, h: 8.6 },
    { name: "Lift (GF)", key: "Lift_GF_2.4_2.4", level: "Ground_Floor", type: "gfa", w: 2.4, h: 2.4 },
    { name: "Lift Corridor (GF)", key: "Lift_Corridor_GF_10_2.4", level: "Ground_Floor", type: "gfa", w: 10, h: 2.4 },
    { name: "Pump Room", key: "Pump_Room_8.5_8", level: "Ground_Floor", type: "service", w: 8.5, h: 8 },
    { name: "RMU Room", key: "RMU_Room_3_3.2", level: "Ground_Floor", type: "service", w: 3, h: 3.2 },
    { name: "Substation", key: "Substation_6.5_5", level: "Ground_Floor", type: "service", w: 6.5, h: 5, role: 'substation', tcl: 1500, numTx: 1 },
    { name: "Telephone Room", key: "Telephone_Room_5.1_4", level: "Ground_Floor", type: "service", w: 5.1, h: 4 },
    { name: "Retail Toilet", key: "Retail_Toilet_2.4_1.5", level: "Ground_Floor", type: "gfa", w: 2.4, h: 1.5 },
    { name: "Retail Accessible Toilet", key: "Retail_Accessible_Toilet_2.4_1.5", level: "Ground_Floor", type: "gfa", w: 2.4, h: 1.5 },
    { name: "Restaurant", key: "Restaurant_15_10", level: "Ground_Floor", type: "gfa", w: 15, h: 10, projectTypes: ['Hotel'] },
    { name: "Ballroom", key: "Ballroom_30_20", level: "Ground_Floor", type: "gfa", w: 30, h: 20, projectTypes: ['Hotel'] },
    { name: "Meeting Room", key: "Meeting_Room_10_8", level: "Podium", type: "gfa", w: 10, h: 8, projectTypes: ['Hotel'] },
    { name: "Swimming Pool", key: "Swimming_Pool_15_7", level: "Podium", type: "builtup", w: 15, h: 7 },
    { name: "Comm_Staircase_Podium", key: "Comm_Staircase_Podium_6_3", level: "Podium", type: "gfa", w: 6, h: 3, role: 'staircase' },
    { name: "Corridor (Podium)", key: "Corridor_Podium_12.8_2.4", level: "Podium", type: "gfa", w: 12.8, h: 2.4 },
    { name: "Electrical Room (Podium)", key: "Electrical_Room_Podium_4_3.5", level: "Podium", type: "service", w: 4, h: 3.5 },
    { name: "Lift (Podium)", key: "Lift_Podium_2.4_2.4", level: "Podium", type: "gfa", w: 2.4, h: 2.4 },
    { name: "Water Meter (Podium)", key: "Water_Meter_Podium_1.7_1.7", level: "Podium", type: "service", w: 1.7, h: 1.7 },
    { name: "Meeting Room", key: "Meeting_Room_10_8", level: "Mezzanine", type: "gfa", w: 10, h: 8, projectTypes: ['Hotel'] },
    { name: "Swimming Pool", key: "Swimming_Pool_15_7", level: "Mezzanine", type: "builtup", w: 15, h: 7 },
    { name: "Comm_Staircase_Mezzanine", key: "Comm_Staircase_Mezzanine_6_3", level: "Mezzanine", type: "gfa", w: 6, h: 3, role: 'staircase' },
    { name: "Corridor (Mezzanine)", key: "Corridor_Mezzanine_12.8_2.4", level: "Mezzanine", type: "gfa", w: 12.8, h: 2.4 },
    { name: "Electrical Room (Mezzanine)", key: "Electrical_Room_Mezzanine_4_3.5", level: "Mezzanine", type: "service", w: 4, h: 3.5 },
    { name: "Lift_Mezzanine", key: "Lift_Mezzanine_2.4_2.4", level: "Mezzanine", type: "gfa", w: 2.4, h: 2.4 },
    { name: "Water Meter (Mezzanine)", key: "Water_Meter_Mezzanine_1.7_1.7", level: "Mezzanine", type: "service", w: 1.7, h: 1.7 },
    { name: "Comm. Corridor (Typical)", key: "Comm_Corridor_Typical_21_1.8", level: "Typical_Floor", type: "gfa", w: 21, h: 1.8 },
    { name: "Comm. Electrical Room", key: "Comm_Electrical_Room_10_1", level: "Typical_Floor", type: "service", w: 10, h: 1 },
    { name: "Comm. Garbage Chute", key: "Comm_Garbage_Chute_2.7_1.5", level: "Typical_Floor", type: "service", w: 2.7, h: 1.5 },
    { name: "Comm. Lift Corridor", key: "Comm_Lift_Corridor_6.6_2.4", level: "Typical_Floor", type: "gfa", w: 6.6, h: 2.4 },
    { name: "Comm_Staircase_Typical", key: "Comm_Staircase_Typical_6_3", level: "Typical_Floor", type: "gfa", w: 6, h: 3, role: 'staircase' },
    { name: "Comm. Tele Room", key: "Comm_Tele_Room_2.4_3.5", level: "Typical_Floor", type: "service", w: 2.4, h: 3.5 },
    { name: "Comm. Water Meter", key: "Comm_Water_Meter_1.7_1.7", level: "Typical_Floor", type: "service", w: 1.7, h: 1.7 },
    { name: "Comm. Water Meter", key: "Comm_Water_Meter_4_1", level: "Typical_Floor", type: "service", w: 4, h: 1 },
    { name: "Lift_Typical", key: "Lift_Typical_2.4_2.4", level: "Typical_Floor", type: "gfa", w: 2.4, h: 2.4},
    { name: "Shaft", key: "Shaft_2_2", level: "Typical_Floor", type: "service", w: 2.0, h: 2.0},
    { name: "Comm. Gym", key: "Comm_Gym_583_1", level: "Roof", type: "service", w: 583, h: 1 },
    { name: "Comm. Service (Roof)", key: "Comm_Service_Roof_124_1", level: "Roof", type: "service", w: 124, h: 1 },
    { name: "Electrical Room", key: "Electrical_Room_3_3.2", level: "Roof", type: "service", w: 3, h: 3.2 },
    { name: "Garbage Chute", key: "Garbage_Chute_2.7_1.5", level: "Roof", type: "service", w: 2.7, h: 1.5 },
    { name: "GSM room", key: "GSM_room_2.7_1.5", level: "Roof", type: "service", w: 2.7, h: 1.5 },
    { name: "Comm_Staircase_Roof", key: "Comm_Staircase_Roof_6_3", level: "Roof", type: "gfa", w: 6, h: 3, role: 'staircase' },
    { name: "Corridor (Roof)", key: "Corridor_Roof_6.6_2.4", level: "Roof", type: "gfa", w: 6.6, h: 2.4 },
    { name: "Lift (Roof)", key: "Lift_Roof_2.4_2.4", level: "Roof", type: "gfa", w: 2.4, h: 2.4 },
    { name: "Terrace Area", key: "Terrace_Area_0.5_1166", level: "Roof", type: "builtup", w: 0.5, h: 1166 },
    // NEW School Blocks
    { name: "Admin Office", key: "Admin_Office_30_30", level: "Ground_Floor", type: "gfa", w: 30, h: 30, role: 'admin_area', projectTypes: ['School'] },
    { name: "School Library", key: "School_Library_15_20", level: "Ground_Floor", type: "gfa", w: 15, h: 20, projectTypes: ['School'] },
    { name: "School Clinic", key: "School_Clinic_6_8", level: "Ground_Floor", type: "gfa", w: 6, h: 8, projectTypes: ['School'] },
    { name: "Auditorium", key: "Auditorium_25_35", level: "Ground_Floor", type: "gfa", w: 25, h: 35, projectTypes: ['School'] },
    { name: "Play Area", key: "Play_Area_10_10", level: "Ground_Floor", type: "builtup", w: 10, h: 10, projectTypes: ['School'] },
    { name: "Covered Play Area", key: "Covered_Play_Area_20_20", level: "Ground_Floor", type: "builtup", w: 20, h: 20, projectTypes: ['School'] },
    // NEW Labour Camp Blocks
    { name: "Mess Hall", key: "Mess_Hall_20_30", level: "Ground_Floor", type: "gfa", w: 20, h: 30, projectTypes: ['LabourCamp'] },
    { name: "Camp Kitchen", key: "Camp_Kitchen_15_15", level: "Ground_Floor", type: "service", w: 15, h: 15, projectTypes: ['LabourCamp'] },
    { name: "Recreation Room", key: "Recreation_Room_10_15", level: "Ground_Floor", type: "gfa", w: 10, h: 15, projectTypes: ['LabourCamp'] }
];

export const PREDEFINED_COMPOSITE_BLOCKS = [
    { name: "Residential Core 1", level: "Typical_Floor", blocks: [ { key: "Comm_Staircase_Typical_6_3", x: 0, y: 0 }, { key: "Comm_Staircase_Typical_6_3", x: 8.8, y: 0 }, { key: "Lift_Typical_2.4_2.4", x: 6.2, y: 0 }, { key: "Lift_Typical_2.4_2.4", x: 6.2, y: 2.6 }, { key: "Shaft_2_2", x: 6.3, y: 5.2 } ] },
    { name: "Ground Floor Core", level: "Ground_Floor", blocks: [ { key: "Comm_Staircase_GF_6_3", x: 0, y: 8 }, { key: "Comm_Staircase_GF_6_3", x: 23, y: 8 }, { key: "Lift_(GF)_2.4_2.4", x: 7, y: 8.3 }, { key: "Lift_(GF)_2.4_2.4", x: 9.6, y: 8.3 }, { key: "Shaft_2_2", x: 8.8, y: 2.9 }, { key: "Comm._Garbage_Chute_2.7_1.5", x: 6, y: 2.9 }, { key: "Electrical_Room_3_3", x: 0, y: 3.2 }, { key: "Substation_6.5_5", x: 20.5, y: 11.5 }, { key: "LV_Room_5.1_8.6", x: 15.2, y: 12 }, { key: "ETS_Room_9_9", x: 0, y: 11.5 }, { key: "Pump_Room_8.5_8", x: 9.2, y: 12 }, { key: "Garbage_Room_8_1", x: 0, y: 20.7 }, { key: "Telephone_Room_5.1_4", x: 20.5, y: 22.2 }, { key: "Electrical_Room_3_3", x: 25.8, y: 22.2 }, { key: "Water_Meter_(Podium)_1.7_1.7", x: 29, y: 24.5 }, { key: "Control_Room_19_1", x: 0, y: 0 },{ key: "Entrance_Lobby_8_12", x: 0, y: 0 }  ] },
    { name: "Podium Floor Core", level: "Podium", blocks: [ { key: "Comm_Staircase_Podium_6_3", x: 0, y: 0 }, { key: "Comm_Staircase_Podium_6_3", x: 14.8, y: 0 }, { key: "Lift_(Podium)_2.4_2.4", x: 6.2, y: 0.3 }, { key: "Lift_(Podium)_2.4_2.4", x: 8.8, y: 0.3 }, { key: "Corridor_(Podium)_12.8_2.4", x: 1.8, y: 3 }, { key: "Electrical_Room_(Podium)_4_3.5", x: 0, y: 3.2 }, { key: "Telephone_Room_5.1_4", x: 4.2, y: 5.6 }, { key: "Garbage_Room_8_1", x: 9.5, y: 5.6 }, { key: "Water_Meter_(Podium)_1.7_1.7", x: 17.7, y: 5.6 } ] },
    { name: "Mezzanine Floor Core", level: "Mezzanine", blocks: [ { key: "Comm_Staircase_Mezzanine_6_3", x: 0, y: 0 }, { key: "Comm_Staircase_Mezzanine_6_3", x: 14.8, y: 0 }, { key: "Lift_Mezzanine_2.4_2.4", x: 6.2, y: 0.3 }, { key: "Lift_Mezzanine_2.4_2.4", x: 8.8, y: 0.3 }, { key: "Corridor_(Mezzanine)_12.8_2.4", x: 1.8, y: 3 }, { key: "Electrical_Room_(Mezzanine)_4_3.5", x: 0, y: 3.2 }, { key: "Telephone_Room_5.1_4", x: 4.2, y: 5.6 }, { key: "Garbage_Room_8_1", x: 9.5, y: 5.6 }, { key: "Water_Meter_(Mezzanine)_1.7_1.7", x: 17.7, y: 5.6 } ] },
    { name: "Basement Floor Core", level: "Basement", blocks: [ { key: "Comm._Staircase_(Basement)_6_3", x: 0, y: 0 }, { key: "Comm._Staircase_(Basement)_6_3", x: 14.8, y: 0 }, { key: "Lift_(Basement)_2.4_2.4", x: 6.2, y: 0.3 }, { key: "Lift_(Basement)_2.4_2.4", x: 8.8, y: 0.3 }, { key: "Lift_(Basement)_2.4_2.4", x: 6.2, y: 2.9 }, { key: "Lift_(Basement)_2.4_2.4", x: 8.8, y: 2.9 }, { key: "Lift_Corridor_(GF)_10_2.4", x: 3.5, y: 5.5 }, { key: "Electrical_Room_3_3", x: 0, y: 3.2 }, { key: "Telephone_Room_5.1_4", x: 3.2, y: 8.1 }, { key: "Garbage_Room_8_1", x: 8.5, y: 8.1 }, { key: "Water_Meter_(Podium)_1.7_1.7", x: 16.7, y: 8.1 }, { key: "GSM_Room_3_3", x: 17, y: 3.2 } ] },
    { name: "Typical Floor Core", level: "Typical_Floor", blocks: [ { key: "Comm_Staircase_Typical_6_3", x: 0, y: 0 }, { key: "Comm_Staircase_Typical_6_3", x: 14.8, y: 0 }, { key: "Lift_Typical_2.4_2.4", x: 6.2, y: 0.3 }, { key: "Lift_Typical_2.4_2.4", x: 8.8, y: 0.3 }, { key: "Lift_Typical_2.4_2.4", x: 6.2, y: 2.9 }, { key: "Lift_Typical_2.4_2.4", x: 8.8, y: 2.9 }, { key: "Comm._Lift_Corridor_6.6_2.4", x: 5.1, y: 5.5 }, { key: "Comm._Electrical_Room_10_1", x: 0, y: 3.2 }, { key: "Comm._Tele_Room_2.4_3.5", x: 12.2, y: 3.2 }, { key: "Comm._Garbage_Chute_2.7_1.5", x: 11.9, y: 6.9 }, { key: "Comm._Water_Meter_1.7_1.7", x: 14.8, y: 6.9 } ] },
    { name: "Roof Floor Core", level: "Roof", blocks: [ { key: "Comm_Staircase_Roof_6_3", x: 0, y: 0 }, { key: "Comm_Staircase_Roof_6_3", x: 14.8, y: 0 }, { key: "Lift_(Roof)_2.4_2.4", x: 6.2, y: 0.3 }, { key: "Lift_(Roof)_2.4_2.4", x: 8.8, y: 0.3 }, { key: "Lift_(Roof)_2.4_2.4", x: 6.2, y: 2.9 }, { key: "Lift_(Roof)_2.4_2.4", x: 8.8, y: 2.9 }, { key: "Corridor_(Roof)_6.6_2.4", x: 5.1, y: 5.5 }, { key: "Electrical_Room_(Podium)_4_3.5", x: 0, y: 3.2 }, { key: "Comm._Tele_Room_2.4_3.5", x: 12.2, y: 3.2 }, { key: "Garbage_Room_8_1", x: 4.8, y: 8.1 }, { key: "Comm._Water_Meter_1.7_1.7", x: 13, y: 8.1 }, { key: "GSM_Room_3_3", x: 17.2, y: 3.2 } ] }
];

export const HOTEL_REQUIREMENTS = {
    "1-star": {
        "Public Areas": [
            { code: "1.1.1.02", type: "O", text: "Clear exterior signage, visible from main road, with Arabic & English names at 50% each." },
            { code: "1.1.1.02", type: "L", text: "Hotel entrance clearly identifiable and illuminated at night." },
            { code: "1.1.2.03", type: "L", text: "All entrance areas have access for disabled guests." },
            { code: "1.1.2.04", type: "O", text: "Lobby and reception area with seating provided." },
            { code: "1.1.2.04", type: "O", text: "Free wireless in all areas and rooms (512 Kbps upload / 1 Mbps download)." },
            { code: "1.1.2.13", type: "L", text: "1 set of public toilets for gents & ladies on the same floor as outlets." },
            { code: "1.1.2.13", type: "L", text: "**At least 1 independent toilet for disabled guests." },
            { code: "1.1.2.09", type: "L", text: "**If 2 levels or more, guest lift is present and travels to all floors." },
        ],
        "Food & Beverage": [
            { code: "2.2.1.06", type: "L", text: "**Minimum of 1 restaurant available for all day dining." },
            { code: "2.2.1.06", type: "L", text: "Seating provided for at least 50% of keys." },
            { code: "2.3.1.12", type: "O", text: "Breakfast, lunch, and dinner available." },
            { code: "2.3.1.14", type: "O", text: "At least Continental breakfast offered." },
        ],
        "Bedroom": [
            { code: "6.1.1.01", type: "L", text: "Minimum 10 rooms." },
            { code: "6.1.1.01", type: "L", text: "Minimum 1 room with disabled facilities (scales with total room count)." },
            { code: "6.1.1.01", type: "L", text: "Minimum room size of 13 sqm (including bathroom)." },
            { code: "6.1.1.01", type: "L", text: "**Bathroom with shower only, minimum 3.5 sqm." },
            { code: "6.1.2.03", type: "L", text: "Individual switches for lighting and in-room A/C controls." },
            { code: "6.1.2.02", type: "L", text: "Each room has an entrance door with spy hole and automatic/secondary locking." },
            { code: "6.2.1.08", type: "O", text: "Double bed size minimum 150cm x 190cm." },
            { code: "6.2.2.10", type: "L", text: "**Wardrobe dimensions at least 60cm deep, with minimum 5 hangers." },
            { code: "6.4.1.15", type: "O", text: "Colour TV, free of charge, with local channels." },
        ],
         "Bathroom": [
            { code: "7.1.1.01", type: "L", text: "En-suite bathroom in each room." },
            { code: "7.1.1.02", type: "L", text: "Shower or shower over bath present." },
            { code: "7.1.1.04", type: "L", text: "Hot and cold water available with strong flow." },
            { code: "7.2.1.06", type: "O", text: "One set of towels per person (1 hand, 1 bath)." },
        ],
    },
    "2-star": {
        "Message": "Data for 2-Star hotels is not available in the provided documents."
    },
    "3-star": {
        "Public Areas": [
            { code: "1.1.2.04", type: "L", text: "Clearly designated lobby / reception area." },
            { code: "1.1.2.04", type: "O", text: "Seating for at least 5% of keys." },
            { code: "1.1.2.09", type: "L", text: "**Main building: If 2 levels or more, guest lift present." },
            { code: "1.1.2.13", type: "L", text: "**1 set of public toilets for gents and ladies near outlets." },
            { code: "1.1.2.14", type: "L", text: "**Prayer area on site (16 sqm min) or a Masjid is available within 500m."}
        ],
        "Food & Beverage": [
             { code: "2.2.1.06", type: "L", text: "**Minimum of 1 restaurant available for all day dining." },
             { code: "2.3.1.13", type: "O", text: "Buffet items are consistently replenished and correctly labelled." },
             { code: "2.4.1.19", type: "O", text: "Food & Beverage room service available from 6am to 11pm."}
        ],
        "Bedroom": [
            { code: "6.1.1.01", type: "L", text: "Minimum 10 rooms." },
            { code: "6.1.1.01", type: "L", text: "Minimum room size of 16 sqm (including bathroom)." },
            { code: "6.1.1.01", type: "L", text: "**Bathroom: 3.8 sqm with tub/shower, 3.5 sqm with shower only." },
            { code: "6.1.2.03", type: "L", text: "Lighting master switch, or power shut off at door (e.g. key card)." },
            { code: "6.2.2.10", type: "L", text: "**Wardrobe dimensions at least: 60cm deep, 30cm wide per person." },
            { code: "6.2.3.12", type: "O", text: "Safety Deposit Box provided in 50% of all bedrooms." },
        ],
        "Bathroom": [
            { code: "7.1.1.02", type: "E", text: "At least 25% of all rooms have a bathtub." },
            { code: "7.1.1.05", type: "L", text: "Conveniently located electric shaver point." },
            { code: "7.2.1.07", type: "O", text: "Individually packaged soap, shower gel, and shampoo provided." },
        ]
    },
    "4-star": {
        "Public Areas": [
            { code: "1.1.1.01", type: "L", text: "Car parking spaces available and approved by Dubai Municipality." },
            { code: "1.1.2.04", type: "E", text: "1 ATM Machine may be available for guest use." },
            { code: "1.1.2.09", type: "L", text: "**Main Building: 2+ levels, guest lift. External Building: 3+ levels, guest lift." },
            { code: "1.1.2.11", type: "L", text: "Separate service/delivery and staff entrances." },
            { code: "4.9.1.13", type: "L", text: "Business centre services or a dedicated facility exists." },
        ],
        "Food & Beverage": [
            { code: "2.2.1.06", type: "L", text: "**At least 2 restaurant facilities available, one with all day dining." },
            { code: "2.2.1.06", type: "L", text: "Seating provided equivalent to not less than 70% of keys." },
            { code: "2.4.1.19", type: "O", text: "Food & Beverage service provided 24 hours." },
            { code: "2.5.1.22", type: "O", text: "Selection of lounge, arm chairs and bar stools available in Bar/Lounge." }
        ],
        "Leisure": [
            { code: "5.1.3.06", type: "L", text: "Gymnasium present." },
            { code: "5.1.6.10", type: "L", text: "Hotel has at least one pool, indoors or outdoors. All pools temperature controlled." },
        ],
        "Bedroom": [
            { code: "6.1.1.01", type: "L", text: "Minimum room size of 22 sqm (including bathroom)." },
            { code: "6.1.1.01", type: "L", text: "**Bathroom: 3.8 sqm with tub/shower, 3.5 sqm with shower only." },
            { code: "6.2.1.08", type: "O", text: "Single Bed size minimum 120cm x 200cm. Double bed size minimum 180cm x 200cm." },
            { code: "6.2.3.11", type: "O", text: "Minibar stocked with snacks and soft beverages." },
            { code: "6.3.1.14", type: "L", text: "At least 3 available sockets for guest use." },
        ],
        "Suite": [
            { code: "8.3.2.01", type: "L", text: "5% of total inventory must be suites (2 separate rooms)." },
            { code: "8.3.2.01", type: "L", text: "**Minimum suite size 42 sqm." }
        ]
    },
    "5-star": {
        "Public Areas": [
            { code: "1.1.2.10", type: "L", text: "**Separate lift for hotel services (luggage, laundry)." },
            { code: "4.7.1.11", type: "O", text: "24 hour concierge service is provided." },
            { code: "4.7.1.11", type: "O", text: "Valet parking service available 24 hours." },
            { code: "4.9.1.17", type: "L", text: "**At least 1 Retail Shop and 1 Gift Shop provided." },
        ],
        "Leisure": [
            { code: "5.1.1.02", type: "L", text: "If Spa exists, minimum of 3 treatment rooms." },
            { code: "5.1.4.07", type: "L", text: "Kids club in a specially built facility." },
            { code: "5.1.6.10", type: "L", text: "At least one certified Lifeguard on duty during stated hours of operation." },
        ],
        "Bedroom": [
            { code: "6.1.1.01", type: "L", text: "Minimum 30 sqm (including bathroom)." },
            { code: "6.1.1.01", type: "L", text: "**Bathroom: Minimum 4.5 sqm." },
            { code: "6.1.2.07", type: "E", text: "Room features include cornices, artwork, artefacts, framed mirrors." },
            { code: "6.2.1.08", type: "O", text: "**Double bed size minimum 200cm x 200cm." },
            { code: "6.2.3.12", type: "O", text: "**Safety Deposit Box Provided to fit 17\" laptop." },
        ],
         "Suite": [
            { code: "8.3.2.01", type: "L", "text": "5% of total inventory must have 2 separate rooms (i.e. separate Lounge divided by a wall)." },
            { code: "8.3.2.01", type: "L", "text": "**Minimum 54 sqm (including Master bedroom and master bathroom, living areas)." },
            { code: "8.3.2.01", type: "L", "text": "Kitchenette / Butlers Pantry provided in highest category suite." }
        ],
        "Housekeeping": [
            { code: "9.1.1.01", type: "O", text: "Room Cleaning service provided daily between 6am-10pm." },
            { code: "9.1.1.01", type: "O", text: "Turn down service provided 6-10pm." },
            { code: "9.1.1.03", type: "O", text: "Same day Laundry & Dry Cleaning service provided 7 days of week." },
            { code: "9.1.1.05", type: "O", text: "24 hour shoe cleaning service available free of charge." },
        ]
    },
    "6-star": {
        "Message": "Data for 6-Star hotels is not available. Please refer to official documentation."
    },
    "7-star": {
        "Message": "Data for 7-Star hotels is not available. Please refer to official documentation."
    }
};


// --- Helper Setup ---


export const PREDEFINED_BLOCKS = {};
AREA_STATEMENT_DATA.forEach(item => {
    const key = `${item.name.replace(/[\s()./]/g, '_')}_${item.w}_${item.h}`;
    PREDEFINED_BLOCKS[key] = {
         key: key, // Add the key to the data object itself for easier lookup
        name: item.name,
        width: parseFloat(item.w),
        height: parseFloat(item.h),
        level: item.level,
        category: item.type,
        role: item.role, // e.g., 'staircase', 'substation'
        tcl: item.tcl, // default TCL for substation
        numTx: item.numTx, // default # of transformers for substation
        projectTypes: item.projectTypes // Keep this property
    };
});
// ******************************************************************
// ***** NEW DATA FOR MARKET RATE CALCULATOR *****
// ******************************************************************

export const DUBAI_LOCATIONS = [
    { id: 'al_barari', name: 'Al Barari', lat: 25.0934, lng: 55.3341 },
    { id: 'al_barsha', name: 'Al Barsha', lat: 25.1165, lng: 55.2069 },
    { id: 'al_furjan', name: 'Al Furjan', lat: 25.0311, lng: 55.1506 },
    { id: 'al_garhoud', name: 'Al Garhoud', lat: 25.2458, lng: 55.3456 },
    { id: 'al_jaddaf', name: 'Al Jaddaf', lat: 25.2227, lng: 55.3318 },
    { id: 'al_karama', name: 'Al Karama', lat: 25.2471, lng: 55.3055 },
    { id: 'al_satwa', name: 'Al Satwa', lat: 25.2155, lng: 55.2709 },
    { id: 'arabian_ranches', name: 'Arabian Ranches', lat: 25.0503, lng: 55.2526 },
    { id: 'arabian_ranches_2', name: 'Arabian Ranches 2', lat: 25.0431, lng: 55.2758 },
    { id: 'arjan', name: 'Arjan', lat: 25.0682, lng: 55.2250 },
    { id: 'barsha_heights', name: 'Barsha Heights (TECOM)', lat: 25.0945, lng: 55.1735 },
    { id: 'bluewaters', name: 'Bluewaters Island', lat: 25.0805, lng: 55.1235 },
    { id: 'bur_dubai', name: 'Bur Dubai', lat: 25.2593, lng: 55.2974 },
    { id: 'business_bay', name: 'Business Bay', lat: 25.1852, lng: 55.2676 },
    { id: 'city_walk', name: 'City Walk', lat: 25.2078, lng: 55.2644 },
    { id: 'damac_hills', name: 'DAMAC Hills', lat: 25.0450, lng: 55.2442 },
    { id: 'damac_hills_2', name: 'DAMAC Hills 2', lat: 25.0401, lng: 55.4217 },
    { id: 'deira', name: 'Deira', lat: 25.2631, lng: 55.3377 },
    { id: 'difc', name: 'DIFC', lat: 25.2131, lng: 55.2818 },
    { id: 'discovery_gardens', name: 'Discovery Gardens', lat: 25.0416, lng: 55.1408 },
    { id: 'downtown_dubai', name: 'Downtown Dubai', lat: 25.1972, lng: 55.2744 },
    { id: 'dubai_creek_harbour', name: 'Dubai Creek Harbour', lat: 25.2100, lng: 55.3470 },
    { id: 'dubai_hills_estate', name: 'Dubai Hills Estate', lat: 25.1119, lng: 55.2618 },
    { id: 'dubai_investment_park', name: 'Dubai Investment Park (DIP)', lat: 24.9818, lng: 55.1923 },
    { id: 'dubai_marina', name: 'Dubai Marina', lat: 25.0783, lng: 55.1399 },
    { id: 'dubai_silicon_oasis', name: 'Dubai Silicon Oasis', lat: 25.1215, lng: 55.3884 },
    { id: 'dubai_south', name: 'Dubai South', lat: 24.9123, lng: 55.2023 },
    { id: 'dubai_sports_city', name: 'Dubai Sports City', lat: 25.0503, lng: 55.2205 },
    { id: 'emaar_beachfront', name: 'Emaar Beachfront', lat: 25.0933, lng: 55.1481 },
    { id: 'emirates_hills', name: 'Emirates Hills', lat: 25.0772, lng: 55.1819 },
    { id: 'international_city', name: 'International City', lat: 25.1685, lng: 55.4093 },
    { id: 'jbr', name: 'Jumeirah Beach Residence (JBR)', lat: 25.0768, lng: 55.1328 },
    { id: 'jge', name: 'Jumeirah Golf Estates (JGE)', lat: 25.0305, lng: 55.2118 },
    { id: 'jlt', name: 'Jumeirah Lake Towers (JLT)', lat: 25.0664, lng: 55.1413 },
    { id: 'jumeirah_1', name: 'Jumeirah 1', lat: 25.2312, lng: 55.2589 },
    { id: 'jvc', name: 'Jumeirah Village Circle (JVC)', lat: 25.0531, lng: 55.2038 },
    { id: 'jvt', name: 'Jumeirah Village Triangle (JVT)', lat: 25.0518, lng: 55.1834 },
    { id: 'meydan_city', name: 'Meydan City', lat: 25.1667, lng: 55.3000 },
    { id: 'mira', name: 'Mira', lat: 25.0117, lng: 55.2936 },
    { id: 'mirdif', name: 'Mirdif', lat: 25.2136, lng: 55.4192 },
    { id: 'motor_city', name: 'Motor City', lat: 25.0505, lng: 55.2393 },
    { id: 'mudon', name: 'Mudon', lat: 25.0342, lng: 55.2639 },
    { id: 'oud_metha', name: 'Oud Metha', lat: 25.2378, lng: 55.3134 },
    { id: 'palm_jumeirah', name: 'Palm Jumeirah', lat: 25.1189, lng: 55.1393 },
    // Commercial / Industrial / Special
    { id: 'al_quoz', name: 'Al Quoz (Industrial/Warehouse)', lat: 25.1389, lng: 55.2286 },
    { id: 'dip', name: 'Dubai Investment Park (DIP)', lat: 24.9818, lng: 55.1923 },
    { id: 'jebel_ali', name: 'Jebel Ali (Industrial/Camp)', lat: 24.9897, lng: 55.1235 },
    { id: 'nad_al_sheba', name: 'Nad Al Sheba (School/Residential)', lat: 25.1333, lng: 55.3500 },
    { id: 'dubai_academic_city', name: 'Dubai Academic City (School)', lat: 25.1115, lng: 55.4116 },
    { id: 'port_de_la_mer', name: 'Port de La Mer', lat: 25.2536, lng: 55.2655 },
    { id: 'ras_al_khor', name: 'Ras Al Khor', lat: 25.1900, lng: 55.3567 },
    { id: 'remraam', name: 'Remraam', lat: 25.0210, lng: 55.2345 },
    { id: 'the_greens', name: 'The Greens', lat: 25.0883, lng: 55.1764 },
    { id: 'the_lakes', name: 'The Lakes', lat: 25.0792, lng: 55.1747 },
    { id: 'the_meadows', name: 'The Meadows', lat: 25.0617, lng: 55.1736 },
    { id: 'the_springs', name: 'The Springs', lat: 25.0569, lng: 55.1764 },
    { id: 'the_villa', name: 'The Villa', lat: 25.1053, lng: 55.3533 },
    { id: 'town_square', name: 'Town Square', lat: 25.0069, lng: 55.2789 },
    { id: 'umm_suqeim', name: 'Umm Suqeim', lat: 25.1583, lng: 55.2078 },
    { id: 'villanova', name: 'Villanova', lat: 25.0526, lng: 55.3341 },
    { id: 'world_trade_centre', name: 'World Trade Centre', lat: 25.2267, lng: 55.2889 },
     { id: 'dubai_industrial_city', name: 'Dubai Industrial City', lat: 24.8785, lng: 55.0854 }
].sort((a, b) => a.name.localeCompare(b.name)); // Sort alphabetically

export const MARKET_RATE_PROPERTY_TYPES = [
    { key: 'studio',       name: 'Studio',              baseBuy: 600000,   baseRent: 45000 },
    { key: '1bhk',         name: '1-Bedroom Apt',       baseBuy: 1000000,  baseRent: 75000 },
    { key: '1bhk_study',   name: '1-Bed + Study Apt',   baseBuy: 1200000,  baseRent: 90000 },
    { key: '2bhk',         name: '2-Bedroom Apt',       baseBuy: 1800000,  baseRent: 120000 },
    { key: '3bhk',         name: '3-Bedroom Apt',       baseBuy: 3000000,  baseRent: 180000 },
    { key: '4bhk',         name: '4-Bedroom Apt',       baseBuy: 5000000,  baseRent: 250000 },
    { key: 'townhouse',    name: 'Townhouse',           baseBuy: 2500000,  baseRent: 160000 },
    { key: 'villa',        name: 'Villa',               baseBuy: 4500000,  baseRent: 250000 },
     { key: 'office',       name: 'Office (per sqft)',   baseBuy: 1200,     baseRent: 100 },
    { key: 'retail',       name: 'Retail (per sqft)',   baseBuy: 2000,     baseRent: 180 },
    { key: 'warehouse',    name: 'Warehouse (per sqft)',baseBuy: 400,      baseRent: 35 },
    { key: 'labour_camp',  name: 'Labour Camp (per bed/yr)', baseBuy: 25000, baseRent: 4500 } // Note: Rate is per bed
];
// NEW: Simulated land rates per sqft of GFA for different areas
export const DUBAI_LAND_RATES = {
    'al_barari': 450,
    'al_barsha': 350,
    'al_furjan': 300,
    'business_bay': 550,
    'downtown_dubai': 800,
    'dubai_hills_estate': 500,
    'dubai_marina': 650,
    'jbr': 600,
    'jlt': 400,
    'jvc': 250,
    'palm_jumeirah': 900,
    'al_quoz': 150,
    'dip': 120,
    'jebel_ali': 100,
    'nad_al_sheba': 280,
    'dubai_academic_city': 200,
    'dubai_industrial_city': 90,
    // Add defaults for any other locations
    'default': 300 
};
```

### 3. `eventHandlers.js` (Wiring the Logic)
This is the most important part. I will add the core `calculateAndApplySetbacks` function and update the event listeners to trigger it.

```javascript
//--- START OF FILE eventHandlers.js ---

// MAIN EXECUTION & INITIALIZATION
// =====================================================================
import { initCanvas, resetZoom,renderPdfToBackground,zoomCanvas ,getCanvas ,clearOverlay ,setCanvasBackground ,getOverlayContext ,redrawApartmentPreview, zoomToObject, drawLiveDimension  } from './canvasController.js';
import { resetState,setCurrentLevel,state,setCurrentMode,setScale, toggleAllLayersVisibility ,rehydrateProgram  } from './state.js';
// --- MODIFICATION START: Import SETBACK_RULES ---
import { initDrawingTools,handleDblClick, getSetbackPolygonPoints,handleCanvasMouseMove,clearSetbackGuides,clearEdgeHighlight,updateAlignmentHighlight,resetDrawingState,handleCanvasMouseDown,clearEdgeSnapIndicator ,finishScaling,drawSetbackGuides,findSnapPoint ,updateSnapIndicators,drawMeasurement, getClickedPlotEdge, findNearestParkingEdge, getNearestEdge, snapObjectToEdge, alignObjectToEdge , updateEdgeHighlight, getClickedPolygonEdge, makeFootprintEditable, makeFootprintUneditable, refreshEditablePolygon, addDrawingPoint            } from './drawingTools.js'; 
import { regenerateParkingInGroup, generateLinearParking   } from './parkingLayoutUtils.js';
import { init3D,generate3DBuilding , generateOpenScadScript  } from './viewer3d.js';
import { initUI, updateUI,displayHotelRequirements ,placeSelectedComposite, handleConfirmLevelOp  ,applyLevelVisibility ,updateLevelFootprintInfo ,renderServiceBlockList,updateSelectedObjectControls , openLevelOpModal,updateParkingDisplay,toggleFloatingPanel,updateDashboard,toggleBlockLock, saveUnitChanges, openNewCompositeEditor, editSelectedComposite, deleteSelectedComposite, saveCompositeChanges, addSubBlockToCompositeEditor, applyScenario, toggleApartmentMode, openEditUnitModal,updateLevelCounts, populateServiceBlocksDropdown, updateProgramUI ,updateMixTotal, updateScreenshotGallery, openAreaStatementModal     } from './uiController.js';
import { exportReportAsPDF,generateReport  } from './reportGenerator.js';
import { PROJECT_PROGRAMS, AREA_STATEMENT_DATA ,PREDEFINED_BLOCKS , BLOCK_CATEGORY_COLORS, LEVEL_ORDER, SETBACK_RULES } from './config.js';
// --- MODIFICATION END ---
import { allocateCountsByPercent, getPolygonProperties, getOffsetPolygon, isPointInRotatedRect, getPolygonFromPolyline } from './utils.js';
import { layoutFlatsOnPolygon } from './apartmentLayout.js';
import { handleDxfUpload, assignDxfAsPlot,finalizeDxf,deleteDxf,updateDxfStrokeWidth, exportProjectZIP, importProjectZIP, exportServiceBlocksCSV, importServiceBlocksCSV  } from './io.js';
import { recordAction } from './actionRecorder.js'; // NEW: for action recorder
import { updateSubstationSize } from './feasibilityEngine.js';

let dimensionInputEl = null;

// --- MODIFICATION START: New function for automatic setbacks ---
export function calculateAndApplySetbacks() {
    if (!state.plotPolygon || !document.getElementById('auto-setback-toggle').checked) {
        return;
    }

    const params = {};
    document.querySelectorAll('.param-input').forEach(input => {
        if (input.type === 'number') params[input.id] = parseInt(input.value) || 0;
    });

    // Calculate total floors above ground. G = 1, G+1 = 2, etc.
    const totalFloorsAboveGround = 1 + (params.numMezzanines || 0) + (params.numPodiums || 0) + (params.numTypicalFloors || 0) + (params.numHotelFloors || 0);

    let neighborSetback = 0;
    let roadSetback = 0;

    const rule = SETBACK_RULES.find(r => totalFloorsAboveGround >= r.minFloors && totalFloorsAboveGround <= r.maxFloors);
    
    if (rule) {
        neighborSetback = rule.neighbor;
        roadSetback = rule.road;
    }

    if (state.plotEdgeProperties.length > 0) {
        state.plotEdgeProperties.forEach(prop => {
            if (prop.type === 'neighbor') {
                prop.distance = neighborSetback;
            } else if (prop.type === 'road') {
                prop.distance = roadSetback;
            }
        });
        
        drawSetbackGuides();

        // If the setback editor is open, update its displayed values
        if (state.currentMode === 'editingSetback' && state.selectedPlotEdges.length > 0) {
            const firstSelectedProps = state.plotEdgeProperties[state.selectedPlotEdges[0]];
            document.getElementById('individual-setback-dist').value = firstSelectedProps.distance;
            const typeRadio = document.getElementById(`edge-type-${firstSelectedProps.type}`);
            if (typeRadio) typeRadio.checked = true;
        }

        document.getElementById('status-bar').textContent = `Auto-setbacks applied: Neighbor=${neighborSetback}m, Road=${roadSetback}m.`;
    }
}
// --- MODIFICATION END ---


function removeDimensionInput() {
    if (dimensionInputEl) {
        document.body.removeChild(dimensionInputEl);
        dimensionInputEl = null;
        state.canvas.defaultCursor = 'crosshair';
    }
}

function commitDimensionInput() {
    if (!dimensionInputEl) return;
    const distMeters = parseFloat(dimensionInputEl.value);
    removeDimensionInput(); 
    if (isNaN(distMeters) || distMeters <= 0 || state.scale.ratio === 0) return;

    const distPixels = distMeters / state.scale.ratio;
    const lastPt = polygonPoints[polygonPoints.length - 1];
    const mousePt = state.lastMousePointer;

    if (!lastPt || !mousePt) return;
    
    const dx = mousePt.x - lastPt.x;
    const dy = mousePt.y - lastPt.y;
    const currentDist = Math.hypot(dx, dy);

    if (currentDist === 0) return;

    const unitVec = { x: dx / currentDist, y: dy / currentDist };
    const newPoint = {
        x: lastPt.x + unitVec.x * distPixels,
        y: lastPt.y + unitVec.y * distPixels
    };

    addDrawingPoint(newPoint);
}

function showDimensionInput() {
    removeDimensionInput();
    const point = state.lastMousePointer;
    if (!point) return;

    const vpt = state.canvas.viewportTransform;
    const canvasRect = state.canvas.getElement().getBoundingClientRect();
    const screenX = point.x * vpt[0] + vpt[4] + canvasRect.left;
    const screenY = point.y * vpt[3] + vpt[5] + canvasRect.top;

    dimensionInputEl = document.createElement('input');
    dimensionInputEl.type = 'text';
    dimensionInputEl.style.position = 'absolute';
    dimensionInputEl.style.left = `${screenX + 15}px`;
    dimensionInputEl.style.top = `${screenY + 15}px`;
    dimensionInputEl.style.zIndex = '10001';
    dimensionInputEl.style.padding = '5px';
    dimensionInputEl.style.border = '2px solid var(--primary-color)';
    dimensionInputEl.style.borderRadius = '4px';
    dimensionInputEl.style.boxShadow = '0 2px 10px rgba(0,0,0,0.3)';
    dimensionInputEl.placeholder = "Enter distance (m)";

    dimensionInputEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); commitDimensionInput(); } 
        else if (e.key === 'Escape') { e.preventDefault(); removeDimensionInput(); }
    });

    document.body.appendChild(dimensionInputEl);
    dimensionInputEl.focus();
}

function handleGlobalKeyDown(e) {
    const isDrawingPoly = ['drawingPlot', 'drawingBuilding', 'drawingLinearBuilding', 'drawingCorridor'].includes(state.currentMode) && polygonPoints.length > 0;
    
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') {
        return;
    }
    
    if (e.key === 'Escape' && state.currentMode) {
        e.preventDefault();
        exitAllModes();
    }


    if (isDrawingPoly && ((e.key >= '0' && e.key <= '9') || e.key === '.')) {
        e.preventDefault();
        showDimensionInput();
        dimensionInputEl.value = e.key;
    }
}

export function setupEventListeners() {
     if (!state.canvas) {
        console.error("Canvas not initialized when setting up listeners");
        return;
    }
    state.canvas.on('mouse:down', handleMouseDown);
    state.canvas.on('mouse:move', handleMouseMove);
    state.canvas.on('mouse:up', handleMouseUp);
    state.canvas.on('mouse:dblclick', handleDblClick);
    state.canvas.on('after:render', handleAfterRender);
    state.canvas.on('selection:created', (e) => updateSelectedObjectControls(e.target));
    state.canvas.on('selection:updated', (e) => updateSelectedObjectControls(e.target));
    state.canvas.on('selection:cleared', () => updateSelectedObjectControls(null));
    state.canvas.on('object:modified', (e) => {
        updateSelectedObjectControls(e.target);
        handleObjectModified(e);
        updateDashboard();
        if(e.target.isFootprint) updateLevelFootprintInfo();
    });
    state.canvas.on('object:scaling',handleObjectScaling);
    state.canvas.on('object:moving', handleObjectMoving);
    
    document.getElementById('floating-header').addEventListener('click', toggleFloatingPanel);
    
    // --- MODIFICATION START: Update param-input listener ---
    document.querySelectorAll('.param-input').forEach(inp => {
        const eventType = inp.type === 'checkbox' ? 'change' : 'input';
        inp.addEventListener(eventType, () => { 
            updateLevelCounts(); 
            calculateAndApplySetbacks(); // This is the new call
            handleCalculate(true); 
            updateDashboard(); // Re-added this call
        });
    });
    // --- MODIFICATION END ---
    
    document.getElementById('toggle-lock-btn').addEventListener('click', toggleBlockLock);
    document.getElementById('zip-upload').addEventListener('change', handleImportZIP);
    document.getElementById('export-zip-btn').addEventListener('click', async () => {
        document.getElementById('status-bar').textContent = 'Generating project zip... Please wait.';
        try {
            await exportProjectZIP(state.canvas);
            document.getElementById('status-bar').textContent = 'Project exported successfully.';
        } catch (error) {
            console.error("Failed to export ZIP:", error);
            document.getElementById('status-bar').textContent = `Error exporting project: ${error.message}`;
        }
    });
    document.getElementById('dxf-upload').addEventListener('change', handleDxfUpload);
    document.getElementById('assign-dxf-plot-btn').addEventListener('click', assignDxfAsPlot);
    document.getElementById('zoom-to-dxf-btn').addEventListener('click', () => zoomToObject(state.dxfOverlayGroup));
    document.getElementById('finalize-dxf-btn').addEventListener('click', finalizeDxf);
    document.getElementById('delete-dxf-btn').addEventListener('click', deleteDxf);
    document.getElementById('dxf-stroke-width').addEventListener('input', updateDxfStrokeWidth);
    document.getElementById('edit-footprint-btn').addEventListener('click', () => enterMode('editingFootprint'));
    document.getElementById('confirm-footprint-btn').addEventListener('click', confirmFootprintEdit);
    document.getElementById('delete-footprint-btn').addEventListener('click', deleteSelectedObject);
    document.getElementById('plan-upload').addEventListener('change', handlePlanUpload);

    const uploadLabel = document.querySelector('label[for="plan-upload"]');
    if (uploadLabel) {
        // Prevent default browser behavior to allow drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadLabel.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });

        // Add visual feedback for drag-over
        ['dragenter', 'dragover'].forEach(eventName => {
            uploadLabel.addEventListener(eventName, () => {
                uploadLabel.style.backgroundColor = '#f50057'; // Use accent color
                uploadLabel.style.border = '2px dashed white';
            }, false);
        });

        // Remove visual feedback
        ['dragleave', 'drop'].forEach(eventName => {
            uploadLabel.addEventListener(eventName, () => {
                uploadLabel.style.backgroundColor = ''; // Revert to default
                uploadLabel.style.border = '';
            }, false);
        });

        // Handle the file drop
        uploadLabel.addEventListener('drop', (e) => {
            if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                // Pass the dropped files to the existing upload handler
                handlePlanUpload({ target: { files: e.dataTransfer.files } });
            }
        });
    }

    document.getElementById('pdf-page').addEventListener('change', handlePdfPageChange);
    document.getElementById('set-scale-btn').addEventListener('click', () => {
        if (state.currentMode === 'scaling') {
            exitAllModes();
        } 
        else { 
            enterMode('scaling'); 
            document.getElementById('status-bar').textContent = 'Click the start point of a known distance.'; 
        }
    });
   document.getElementById('measure-tool-btn').addEventListener('click', () => {
        if (state.currentMode === 'measuring') {
            exitAllModes();
        } else {
            enterMode('measuring');
        }
    });
    document.getElementById('level-selector').addEventListener('click', handleLevelSelect);
    document.getElementById('toggle-visibility-btn').addEventListener('click', handleToggleVisibility);
    document.getElementById('draw-plot-btn').addEventListener('click', () => enterMode('drawingPlot'));
    document.getElementById('draw-guide-btn').addEventListener('click', () => enterMode('drawingGuide'));
    document.getElementById('draw-building-btn').addEventListener('click', () => enterMode('drawingBuilding'));
    // New Button Listener
    document.getElementById('draw-linear-btn').addEventListener('click', () => enterMode('drawingLinearBuilding'));
     document.getElementById('draw-corridor-btn').addEventListener('click', () => enterMode('drawingCorridor'));
    
    document.getElementById('footprint-from-setbacks-btn').addEventListener('click', createFootprintFromSetbacks);
    document.getElementById('footprint-from-plot-btn').addEventListener('click', createFootprintFromPlot);
    document.getElementById('draw-parking-btn').addEventListener('click', () => enterMode('drawingParking'));
    document.getElementById('draw-parking-on-edge-btn').addEventListener('click', () => enterMode('drawingParkingOnEdge'));
    document.getElementById('draw-bus-bay-btn').addEventListener('click', () => enterMode('drawingBusBay'));
    document.getElementById('draw-loading-bay-btn').addEventListener('click', () => enterMode('drawingLoadingBay'));
    document.getElementById('edit-setbacks-btn').addEventListener('click', () => enterMode('editingSetback'));
    document.getElementById('apply-individual-setback-btn').addEventListener('click', applyIndividualSetbacks);
    document.getElementById('clear-setback-selection-btn').addEventListener('click', clearSetbackSelection);
    document.getElementById('project-type-select').addEventListener('change', handleProjectTypeChange);
    
    document.getElementById('view-hotel-reqs-btn').addEventListener('click', displayHotelRequirements);
    document.getElementById('close-hotel-req-btn').addEventListener('click', () => { document.getElementById('hotel-req-modal').style.display = 'none'; });
    
    document.getElementById('calculateBtn').addEventListener('click', () => handleCalculate(false, false));
    document.getElementById('generateDetailedReportBtn').addEventListener('click', () => handleCalculate(false, true));
    document.getElementById('add-block-btn').addEventListener('click', () => enterMode('placingBlock'));
    document.getElementById('serviceBlockType').addEventListener('change', handleBlockTypeChange);
    document.getElementById('delete-block-btn').addEventListener('click', deleteSelectedObject);
    document.getElementById('flip-h-btn').addEventListener('click', () => flipSelectedObject('X'));
    document.getElementById('flip-v-btn').addEventListener('click', () => flipSelectedObject('Y'));
    document.getElementById('rotate-90-btn').addEventListener('click', rotateSelectedObject90);
    document.getElementById('align-block-btn').addEventListener('click', startAlignment);
    document.getElementById('move-level-btn').addEventListener('click', () => openLevelOpModal('move'));
    document.getElementById('copy-to-levels-btn').addEventListener('click', () => openLevelOpModal('copy'));
    document.getElementById('block-rotation').addEventListener('change', rotateSelectedObject);
    document.getElementById('block-width').addEventListener('change', () => updateBlockDimension('width'));
    document.getElementById('block-height').addEventListener('change', () => updateBlockDimension('height'));
    
    // Substation listeners
    document.getElementById('substation-tcl').addEventListener('input', () => updateSubstationSize(state.canvas.getActiveObject()));
    document.getElementById('substation-num-tx').addEventListener('input', () => updateSubstationSize(state.canvas.getActiveObject()));


    document.getElementById('place-composite-btn').addEventListener('click', placeSelectedComposite);
    document.getElementById('edit-composite-btn').addEventListener('click', editSelectedComposite);
    document.getElementById('new-composite-btn').addEventListener('click', openNewCompositeEditor);
    document.getElementById('delete-composite-btn').addEventListener('click', deleteSelectedComposite);
    document.getElementById('save-composite-btn').addEventListener('click', saveCompositeChanges);
    document.getElementById('cancel-composite-btn').addEventListener('click', () => document.getElementById('edit-composite-modal').style.display = 'none');
    document.getElementById('add-sub-block-btn').addEventListener('click', addSubBlockToCompositeEditor);
    document.getElementById('scenarioSelect').addEventListener('change', (e) => applyScenario(e.target.value));
    document.getElementById('dist-sliders').addEventListener('input', handleMixerInputChange);
    document.querySelectorAll('input[name="apt-mode"]').forEach(radio => { radio.addEventListener('change', (e) => toggleApartmentMode(e.target.value)); });
     document.getElementById('double-loaded-corridor').addEventListener('change', handlePreviewLayout);
    document.getElementById('apartment-calc-mode').addEventListener('change', handlePreviewLayout);
     document.getElementById('balcony-placement').addEventListener('change', handlePreviewLayout);
    const parkingOverrideCheck = document.getElementById('parking-override-check');
    const parkingOverrideValue = document.getElementById('parking-override-value');
    parkingOverrideCheck.addEventListener('change', () => { parkingOverrideValue.disabled = !parkingOverrideCheck.checked; handleCalculate(true); });
    parkingOverrideValue.addEventListener('input', () => handleCalculate(true));
    
    document.getElementById('unit-cards-container').addEventListener('click', handleUnitCardClick);
    document.getElementById('save-unit-btn').addEventListener('click', saveUnitChanges);
    document.getElementById('cancel-unit-btn').addEventListener('click', () => { document.getElementById('edit-unit-modal').style.display = 'none'; currentlyEditingUnitKey = null; });
    document.getElementById('confirm-level-op-btn').addEventListener('click', handleConfirmLevelOp);
    document.getElementById('cancel-level-op-btn').addEventListener('click', () => document.getElementById('level-op-modal').style.display = 'none');
    document.getElementById('export-pdf-btn').addEventListener('click', exportReportAsPDF);
    document.getElementById('generate3dBtn').addEventListener('click', generate3DBuilding);
    document.getElementById('exportScadBtn').addEventListener('click', generateOpenScadScript);
    document.getElementById('align-core-btn').addEventListener('click', alignCoreElements);
    document.getElementById('previewLayoutBtn').addEventListener('click', handlePreviewLayout);
    document.getElementById('show-balconies-check').addEventListener('change', handlePreviewLayout);
    document.getElementById('show-corridor-check').addEventListener('change', handlePreviewLayout);
    document.getElementById('zoom-in-btn').addEventListener('click', () => zoomCanvas(1.2));
    document.getElementById('zoom-out-btn').addEventListener('click', () => zoomCanvas(1 / 1.2));
    document.getElementById('zoom-reset-btn').addEventListener('click', resetZoom);
    document.getElementById('pan-btn').addEventListener('click', () => enterMode('panning'));
    document.getElementById('edit-group-btn').addEventListener('click', enterGroupEditMode);
    document.getElementById('confirm-group-edit-btn').addEventListener('click', exitGroupEditMode);
    
    // NEW CSV LISTENERS
    document.getElementById('export-blocks-csv-btn').addEventListener('click', exportServiceBlocksCSV);
    document.getElementById('import-blocks-csv-upload').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            importServiceBlocksCSV(file, () => {
                // Callback after import completes
                renderServiceBlockList();
                applyLevelVisibility();
                state.canvas.renderAll();
            });
        }
        e.target.value = ''; // Reset file input
    });

    document.getElementById('area-statement-btn').addEventListener('click', openAreaStatementModal);
    document.getElementById('close-area-statement-btn').addEventListener('click', () => document.getElementById('area-statement-modal').style.display = 'none');
    document.getElementById('save-area-statement-btn').addEventListener('click', saveAreaStatementChanges);
    document.getElementById('reset-area-overrides-btn').addEventListener('click', resetAreaOverrides);
    document.getElementById('add-manual-area-btn').addEventListener('click', addManualAreaEntry);
    document.getElementById('select-tool-btn').addEventListener('click', () => exitAllModes());
    document.getElementById('block-category-select').addEventListener('change', handleCategoryChange);

    // NEW: Listener for PDF detail toggle
    document.querySelectorAll('input[name="report-detail"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            const showGallery = e.target.value === 'full';
            document.getElementById('screenshot-gallery-wrapper').style.display = showGallery ? 'block' : 'none';
        });
    });
    // NEW: Listener for clicks within the report to trigger overrides
    document.getElementById('report-container').addEventListener('click', handleReportClick);

    window.addEventListener('keydown', e => {
        if (e.code === 'Space' && !state.currentMode && !(e.target instanceof HTMLInputElement || e.target instanceof HTMLSelectElement)) {
            e.preventDefault(); enterMode('panning');
        }
        handleGlobalKeyDown(e);
    });
    window.addEventListener('keyup', e => {
        if (e.code === 'Space' && state.currentMode === 'panning') { exitAllModes(); }
    });
}
function handleReportClick(e) {
    // Check if the clicked element or its parent is an editable value
    const editableTarget = e.target.closest('.editable-value');
    if (editableTarget) {
        // If an editable value is clicked, open the area statement modal
        openAreaStatementModal();
    }
}
function handleBalconyClick(pointer) {
    if (!state.currentApartmentLayout || !state.scale.ratio) return false;

    for (const flat of state.currentApartmentLayout.placedFlats) {
        if (!flat.type.balconyMultiplier || flat.type.balconyMultiplier <= 0) continue;

        const balconyWidthPx = (flat.type.frontage / state.scale.ratio) * ((flat.type.balconyCoverage || 80) / 100);
        const balconyDepthPx = flat.type.balconyMultiplier / state.scale.ratio;

        if (isPointInRotatedRect(pointer, flat.balconyCenter, balconyWidthPx, balconyDepthPx, flat.angle)) {
            flat.hasBalcony = !flat.hasBalcony;
            state.canvas.requestRenderAll();
            return true; // Click was handled
        }
    }
    return false;
}
export function handleBlockTypeChange(e) {
    const key = e.target.options[e.target.selectedIndex]?.value;
    if(key && PREDEFINED_BLOCKS[key]?.level) {
        setCurrentLevel(PREDEFINED_BLOCKS[key].level);
        applyLevelVisibility();
        updateUI();
    }
}
export function placeServiceBlock(pointer) {
    const selectEl = document.getElementById('serviceBlockType');
    Array.from(selectEl.selectedOptions).forEach(option => {
        const blockData = PREDEFINED_BLOCKS[option.value];
        if (!blockData || !state.scale.ratio) return;
        const blockWidth = blockData.width / state.scale.ratio;
        const blockHeight = blockData.height / state.scale.ratio;
        const colors = BLOCK_CATEGORY_COLORS[blockData.category || 'default'];
        const blockId = `SB-${state.serviceBlockCounter++}`;
        const rect = new fabric.Rect({ width: blockWidth, height: blockHeight, fill: colors.fill, stroke: colors.stroke, strokeWidth: 2, originX: 'center', originY: 'center', strokeUniform: true });
        rect.setCoords();
        const label = new fabric.Text(blockId, { fontSize: Math.min(blockWidth, blockHeight) * 0.2, fill: '#fff', backgroundColor: 'rgba(0,0,0,0.4)', originX: 'center', originY: 'center' });
          const lockIcon = new fabric.Text("🔒", { fontSize: Math.min(blockWidth, blockHeight) * 0.2, left:Math.min(blockWidth, blockHeight) * 0.2, originY: 'center', visible: true }); // Default Locked
        const group = new fabric.Group([rect, label,lockIcon], {
            left: pointer.x, 
            top: pointer.y, 
            originX: 'center', 
            originY: 'center',
            isServiceBlock: true, 
            blockData:blockData, 
            blockId: blockId, 
            level: state.currentLevel, 
            selectable: true,
            evented: true,
            lockScalingX: true, // Default Locked
            lockScalingY: true,
        });
        state.serviceBlocks.push(group);
        state.canvas.add(group);
        state.canvas.setActiveObject(group);
        
        group.setCoords();
    });
    setCurrentMode(null);
    renderServiceBlockList();
}
export function createCompositeGroup(compositeData, pointer) {
    if (!compositeData || state.scale.ratio === 0) return;
    const items = [];
    const compositeLevel = compositeData.level || state.currentLevel;
    compositeData.blocks.forEach(blockDef => {
        const blockData = PREDEFINED_BLOCKS[blockDef.key];
        if (!blockData) return;
        const blockWidth = (blockDef.w ?? blockData.width) / state.scale.ratio;
        const blockHeight = (blockDef.h ?? blockData.height) / state.scale.ratio;
        const colors = BLOCK_CATEGORY_COLORS[blockData.category || 'default'];
        const blockId = `SB-${state.serviceBlockCounter++}`;
        const rect = new fabric.Rect({ width: blockWidth, height: blockHeight, fill: colors.fill, stroke: colors.stroke, strokeWidth: 2, originX: 'center', originY: 'center', strokeUniform: true });
        const label = new fabric.Text(blockId, { fontSize: Math.min(blockWidth, blockHeight) * 0.2, fill: '#fff', backgroundColor: 'rgba(0,0,0,0.4)', originX: 'center', originY: 'center' });
        
        const x_px = (blockDef.x || 0) / state.scale.ratio;
        const y_px = (blockDef.y || 0) / state.scale.ratio;

        const subGroup = new fabric.Group([rect, label], {
            isServiceBlock: true, blockData, blockId: blockId, level: compositeLevel,
            left: x_px + blockWidth / 2, top: y_px + blockHeight / 2,
            selectable: false, evented: false
        });
        
        state.serviceBlocks.push(subGroup);
        items.push(subGroup);
    });
    const compositeGroup = new fabric.Group(items, { left: pointer.x, top: pointer.y, level: compositeLevel, isCompositeGroup: true });
    state.canvas.add(compositeGroup);
    applyLevelVisibility();
    renderServiceBlockList();
}

export function deleteSelectedFootprint() {
    const selected = state.canvas.getActiveObject();
    if (!selected || !selected.isFootprint) return;

    if (state.currentMode === 'editingFootprint') { confirmFootprintEdit(); }

    const levelObjects = state.levels[selected.level].objects;
    const index = levelObjects.indexOf(selected);
    if (index > -1) { levelObjects.splice(index, 1); }
    state.canvas.remove(selected);
    state.canvas.discardActiveObject().renderAll();
    updateLevelFootprintInfo();
    updateUI();
}
export function deleteSelectedObject() {
    const selected = state.canvas.getActiveObject();
    if (!selected) return;
     
    // NEW: Handle sub-object deletion during group edit
    if (window.isEditingGroup && window.groupBeingEdited && selected.isServiceBlock) {
        const items = window.groupBeingEdited.getObjects();
        const index = items.indexOf(selected);
        if (index > -1) {
            items.splice(index, 1);
        }
    }
    if (selected.isDxfOverlay) { deleteDxf(); return; }
    if (selected.isFootprint) { deleteSelectedFootprint(); return; }
    if (selected.isServiceBlock) state.serviceBlocks = state.serviceBlocks.filter(b => b !== selected);
    else if (selected.isCompositeGroup) state.serviceBlocks = state.serviceBlocks.filter(b => !selected.getObjects().includes(b));
    else if (selected.isParkingRow) state.parkingRows = state.parkingRows.filter(r => r !== selected);
    state.canvas.remove(selected);
    state.canvas.discardActiveObject().renderAll();
    renderServiceBlockList();
    updateParkingDisplay();
}
export function flipSelectedObject(axis) {
    const selected = state.canvas.getActiveObject();
    if (selected) { selected.toggle(axis === 'X' ? 'flipX' : 'flipY'); state.canvas.renderAll(); }
}
export function rotateSelectedObject() {
    const selected = state.canvas.getActiveObject();
    if (selected) { selected.set('angle', parseFloat(document.getElementById('block-rotation').value) || 0).setCoords(); state.canvas.renderAll(); }
}
export function rotateSelectedObject90() {
    const selected = state.canvas.getActiveObject();
    if (selected) {
        const currentAngle = selected.get('angle');
        selected.set('angle', (currentAngle + 90) % 360).setCoords();
        document.getElementById('block-rotation').value = selected.angle.toFixed(1);
        state.canvas.renderAll();
    }
}
export function updateBlockDimension(dimension) {
    const selected = state.canvas.getActiveObject();
    if (!selected || !selected.isServiceBlock || state.scale.ratio === 0) return;
    const rect = selected.getObjects('rect')[0];
    if (!rect) return;
    const input = document.getElementById(dimension === 'width' ? 'block-width' : 'block-height');
    const newMeters = parseFloat(input.value);
    if (isNaN(newMeters) || newMeters <= 0) return;
    const newPixels = newMeters / state.scale.ratio;
    selected.set(dimension === 'width' ? 'scaleX' : 'scaleY', newPixels / rect[dimension]);
    selected.setCoords();
    handleObjectModified({target: selected});
}

function handleImportZIP(e) {
    const file = e.target.files[0];
    if (!file) return;
    importProjectZIP(file, state.canvas, () => {
        // This callback runs after all assets are loaded from the zip and enlivened.
        // We now repopulate the application's state based on the restored objects.
        resetState(true); // true = keep objects that were just loaded but clear state pointers

        let maxId = 0;
        state.canvas.getObjects().forEach(obj => {
            // Restore Plot Polygon state
            if (obj.isPlot) {
                state.plotPolygon = obj;
            }
            // Restore Footprint Polygons state by adding them to the correct level
            else if (obj.isFootprint && obj.level && state.levels[obj.level]) {
                state.levels[obj.level].objects.push(obj);
            }
            // Restore Service Blocks state
            else if (obj.isServiceBlock || obj.isCompositeGroup) {
                state.serviceBlocks.push(obj);
                // Find max service block ID to prevent future ID collisions
                const blocksToCheck = obj.isServiceBlock ? [obj] : obj.getObjects();
                blocksToCheck.forEach(subBlock => {
                     if (subBlock.blockId && subBlock.blockId.startsWith('SB-')) {
                        const idNum = parseInt(subBlock.blockId.split('-')[1]);
                        if (!isNaN(idNum) && idNum > maxId) {
                            maxId = idNum;
                        }
                    }
                });
            }
            // Restore Parking Rows state
            else if (obj.isParkingRow) {
                state.parkingRows.push(obj);
            }
            // Restore Guide Lines state
            else if (obj.isGuide) {
                state.guideLines.push(obj);
            }
            // Restore DXF Overlay state
            else if (obj.isDxfOverlay) {
                state.dxfOverlayGroup = obj;
            }
        });

        // Update the global counter to the next available ID
        state.serviceBlockCounter = maxId + 1;

        document.getElementById('status-bar').textContent = 'Project Imported Successfully.';
        
        // Refresh all UI components that depend on the restored state
        renderServiceBlockList();
        updateParkingDisplay();
        applyLevelVisibility();
        updateLevelFootprintInfo();
        updateUI();
        updateDashboard();
    });
}
export async function handlePlanUpload(e) {
    const file = e.target.files[0];
    if (!file) return;

    state.originalPlanFile = file; // Store the original file object
    resetState();
  
    const reader = new FileReader();
    if (file.type.includes('pdf')) {
        document.getElementById('pdf-controls').style.display = 'block';
        reader.onload = async (event) => {
            currentPdfData = event.target.result;
            await handlePdfPageChange();
            enterMode('scaling'); 
        };
        reader.readAsArrayBuffer(file);
    } else {
        document.getElementById('pdf-controls').style.display = 'none';
        currentPdfData = null;
        reader.onload = (event) => {
            setCanvasBackground(event.target.result);
            enterMode('scaling');
        };
        reader.readAsDataURL(file);
    }
}
export async function handlePdfPageChange() {
    if (currentPdfData) {
        const pageNum = parseInt(document.getElementById('pdf-page').value) || 1;
        const img = await renderPdfToBackground(currentPdfData, pageNum);
        if (img) {
            setCanvasBackground(img);
        }
    }
}
export function createFootprintFromSetbacks() {
    const setbackPoints = getSetbackPolygonPoints();
    if (setbackPoints.length < 3) { 
        document.getElementById('status-bar').textContent = "Could not generate footprint. Ensure setbacks are properly defined.";
        return;
    }
    const footprintPolygon = new fabric.Polygon(setbackPoints, { objectCaching: false, });
    handleFinishPolygon(footprintPolygon, 'drawingBuilding');
}

export function createFootprintFromPlot() {
    if (!state.plotPolygon || !state.plotPolygon.points) {
        document.getElementById('status-bar').textContent = "No plot boundary drawn to create a footprint from.";
        return;
    }
    let points = state.plotPolygon.points;

    // Apply 1m offset for basements
    if (state.currentLevel.startsWith('Basement') && state.scale.ratio > 0) {
        const offsetDist = 1 / state.scale.ratio; // 1 meter offset in pixels
        points = getOffsetPolygon(points, offsetDist);
    }

    if (points.length < 3) {
        document.getElementById('status-bar').textContent = "Could not generate footprint from plot boundary.";
        return;
    }

    const footprintPolygon = new fabric.Polygon(points, { objectCaching: false });
    handleFinishPolygon(footprintPolygon, 'drawingBuilding');
}

export function handleLevelSelect(e) {
    const btn = e.target.closest('button');
    if (btn?.dataset.level) {
        if (state.currentMode === 'editingFootprint') { confirmFootprintEdit(); }
        setCurrentLevel(btn.dataset.level);
        applyLevelVisibility();
        updateUI();
        updateLevelFootprintInfo(); 
    }
}

export function handleToggleVisibility() {
    toggleAllLayersVisibility();
    applyLevelVisibility();
}

export function  handleCalculate(isLiveUpdate = false, isDetailed = false) {
    const reportResult = generateReport(isDetailed);
    if (reportResult) {
        state.lastCalculatedData = reportResult.data;
        document.getElementById('report-container').innerHTML = reportResult.html;
        updateParkingDisplay();
         updateScreenshotGallery();

        // Attach event listeners to ALL expander elements
        const expanders = document.querySelectorAll('#report-container .expander');
        expanders.forEach(expander => {
            expander.addEventListener('click', (e) => {
                const targetId = e.currentTarget.getAttribute('data-target');
                const targetElement = document.getElementById(targetId);
                if (targetElement) {
                    const isHidden = targetElement.style.display === 'none' || !targetElement.style.display;
                    targetElement.style.display = isHidden ? 'table-row' : 'none';
                    e.currentTarget.textContent = isHidden ? '[-]' : '[+]';
                }
            });
        });
    } else {
        if (!isLiveUpdate) { 
            document.getElementById('status-bar').textContent = "Could not generate report. Ensure a plot and at least one typical/hotel floor footprint are drawn.";
        }
        document.getElementById('report-container').innerHTML = '';
        state.lastCalculatedData = null;
        updateParkingDisplay();
    }
    updateUI();
}

export function  handlePreviewLayout(event) {
    const btn = document.getElementById('previewLayoutBtn');
    const calcMode = document.getElementById('apartment-calc-mode').value;
    const balconyPlacement = document.getElementById('balcony-placement').value;
    const includeBalconiesInOffset = balconyPlacement === 'recessed';
    const doubleLoaded = document.getElementById('double-loaded-corridor').checked;

    if (btn.classList.contains('active') && event?.target.id === 'previewLayoutBtn') {
        btn.textContent = 'Preview Layout';
        btn.classList.remove('active');
        state.currentApartmentLayout = null;
        state.canvas.getObjects().filter(o => o.isCorridor).forEach(o => state.canvas.remove(o));
        state.canvas.requestRenderAll();
        return;
    }

    const polys = state.levels['Typical_Floor']?.objects.filter(o => o.isFootprint);
    if (!polys || polys.length === 0 || !state.lastCalculatedData) {
        if (event?.target.id === 'previewLayoutBtn') 
            document.getElementById('status-bar').textContent = "Please draw a Typical Floor and generate a report first.";
        return;
    }
    if (state.projectType !== 'Residential') {
        if (event?.target.id === 'previewLayoutBtn') 
            document.getElementById('status-bar').textContent = "Layout preview is currently only available for Residential projects.";
        return;
    }

    const poly = polys[polys.length - 1]; // Use the last added footprint
    const counts = state.lastCalculatedData.aptCalcs.aptMixWithCounts.reduce((acc, apt) => ({ ...acc, [apt.key]: apt.countPerFloor }), {});
    state.currentApartmentLayout = layoutFlatsOnPolygon(poly, counts, includeBalconiesInOffset, calcMode, doubleLoaded);

    btn.textContent = 'Hide Preview';
    btn.classList.add('active');
    state.canvas.requestRenderAll();
}

async function checkAndRescalePdf() {
    const bg = state.canvas.backgroundImage;
    const pageNum = parseInt(document.getElementById('pdf-page').value) || 1;

    // Check if the background is a PDF we can re-render and if a scale has been set
    if (currentPdfData && bg && bg.isPdf && bg.renderingScale && state.scale.ratio > 0) {
        const pixelsPerMeter = 1 / state.scale.ratio;
        const targetPixelsPerMeter = 100; // Target resolution: 100px per meter (1cm on screen = 1px)

        // Only rescale if current resolution is lower than target
        if (pixelsPerMeter < targetPixelsPerMeter) {
            document.getElementById('status-bar').textContent = 'Optimizing plan resolution... Please wait.';
            const scaleFactor = targetPixelsPerMeter / pixelsPerMeter;
            const newRenderingScale = bg.renderingScale * scaleFactor;
            // Cap the rendering scale to avoid creating enormous textures (e.g., max 8x)
            const finalRenderingScale = Math.min(newRenderingScale, 8.0);

            // Re-render the PDF with the new, higher resolution
            const newBgImage = await renderPdfToBackground(currentPdfData, pageNum, finalRenderingScale);

            if (newBgImage) {
                // Calculate a correction factor based on the change in pixel dimensions
                const correctionFactor = newBgImage.width / bg.width;

                // Apply the new background image
                setCanvasBackground(newBgImage);
                
                // IMPORTANT: Update the application's scale to match the new background resolution
                const newPixelDistance = state.scale.pixelDistance * correctionFactor;
                setScale(newPixelDistance, state.scale.realDistance);
            }
        }
    }
}


export function handleMouseDown(o) {
    const pointer = state.canvas.getPointer(o.e);

    if (state.currentMode === 'editingFootprint') {
        // Prevent starting a drag on the main polygon body
        if (o.target && o.target.isFootprint && !o.transform) {
            return;
        }
    }

    if (state.currentApartmentLayout && o.e.button === 0) { // Left click
            if (handleBalconyClick(pointer)) {
                return; // Prevent other mouse down actions if a balcony was clicked
            }
        }
    if (isMeasuring) {
        document.getElementById('status-bar').textContent='Start measuring';
        const snapPoint = findSnapPoint(pointer);
        const clickPoint = snapPoint ? { x: snapPoint.x, y: snapPoint.y } : pointer;
       
        if (!measurePoint1) {
            measurePoint1 = clickPoint;
            document.getElementById('status-bar').textContent = 'Mode: Measure. Click end point.';
        } else {
            const distPixels = Math.hypot(clickPoint.x - measurePoint1.x, clickPoint.y - measurePoint1.y);
            const distMeters = distPixels * state.scale.ratio;
            document.getElementById('status-bar').textContent = `Final Measurement: ${distMeters.toFixed(3)} m`;
            exitAllModes();
             setCurrentMode(null);
        }
        return;
    }

    if (state.currentMode === 'aligningObject' && objectToAlign) {
        const targetEdge = getNearestEdge(pointer, state.plotPolygon, state.setbackGuides);
        if (targetEdge) {
            alignObjectToEdge(objectToAlign, targetEdge);
            state.canvas.renderAll();
        }
        exitAllModes();
        return;
    }
    if (state.currentMode === 'editingSetback') {
        handleEdgeSelection(pointer);
        return;
    }
    if (state.currentMode === 'scaling') {
        if (!scalePoint1) {
            scalePoint1 = pointer;
            handleCanvasMouseDown(pointer); 
            document.getElementById('status-bar').textContent = 'Click the end point of the known distance.';
        } else {
            const scaleData = finishScaling();
            if (scaleData) {
                setScale(scaleData.pixels, scaleData.meters);
                checkAndRescalePdf();
            } else {
                 document.getElementById('status-bar').textContent = "Invalid length provided. Please enter a number in the 'Known Distance' field.";
            }
            exitAllModes();
        }
        return;
    }
       if (state.currentMode === 'drawingParkingOnEdge') {
        const nearestEdge = findNearestParkingEdge(pointer);
        if (nearestEdge) {
            generateLinearParking(nearestEdge.p1, nearestEdge.p2);
        }
        exitAllModes();
        return;
    }
    if (state.currentMode === 'drawingLoadingBay') {
        const bay = new fabric.Rect({ width: 4 / state.scale.ratio, height: 16 / state.scale.ratio, fill: 'rgba(255, 100, 0, 0.5)', stroke: 'orange', left: pointer.x, top: pointer.y, originX: 'center', originY: 'center', isLoadingBay: true, level: state.currentLevel});
        state.canvas.add(bay);
        exitAllModes();
        return;
    }
     if (state.currentMode === 'drawingBusBay') {
        const bay = new fabric.Rect({ width: 4 / state.scale.ratio, height: 13 / state.scale.ratio, fill: 'rgba(255, 200, 0, 0.5)', stroke: 'yellow', left: pointer.x, top: pointer.y, originX: 'center', originY: 'center', isBusBay: true, level: state.currentLevel});
        state.canvas.add(bay);
        exitAllModes();
        return;
    }
    const result = handleCanvasMouseDown(pointer);
    if (result?.action === 'finishPolygon') {
        alert('finish Polygon');
        handleFinishPolygon(result.polygon);
    }
     if (result?.action === 'finishPolyline') {
        alert('finish Polyline');
        handleFinishPolyline(result.polyline);
    }
    if (state.currentMode === 'placingBlock') placeServiceBlock(pointer);
    if (state.currentMode === 'placingCompositeBlock') {
        const index = document.getElementById('composite-block-select').value;
        const data = state.userCompositeBlocks[index];
        if(data) {
            createCompositeGroup(data, pointer);
        }
        exitAllModes();
    }
    if (state.currentMode === 'drawingParking') {
        parkingStartPoint = pointer;
        parkingLine = new fabric.Line([pointer.x, pointer.y, pointer.x, pointer.y], {
            stroke: '#f50057', strokeWidth: 2, strokeDashArray: [5, 5], selectable: false, evented: false, strokeUniform: true
        });
        state.canvas.add(parkingLine);
    }
}
export function handleMouseMove(o) {
    const pointer = state.canvas.getPointer(o.e);
    state.lastMousePointer = pointer;
    state.lastMousePosition = { x: o.e.clientX, y: o.e.clientY };

    if (state.currentMode === 'measuring') {
        state.canvas.requestRenderAll();
        return;
    }
    if (state.currentMode === 'aligningObject') {
        const targetEdge = getNearestEdge(pointer, state.plotPolygon, state.setbackGuides);
        updateAlignmentHighlight(targetEdge);
        return;
    }
      if (state.currentMode === 'drawingParkingOnEdge') {
        const nearestEdge = findNearestParkingEdge(pointer);
        updateAlignmentHighlight(nearestEdge); // Reuse alignment highlighter
        return;
    }
    if (state.currentMode === 'editingSetback') {
        updateEdgeHighlight(pointer);
        return;
    }
    const moveResult = handleCanvasMouseMove(o) || {};
    state.livePreviewLayout = moveResult.liveLayoutData;
    if (moveResult.liveUnitCounts) updateParkingDisplay(moveUnitCounts);
    if (state.currentMode === 'drawingParking' && parkingLine) {
        parkingLine.set({ x2: pointer.x, y2: pointer.y });
        state.canvas.renderAll();
    }
}


export function  handleMouseUp(o) {
    if (state.currentMode === 'drawingGuide' && guideLine) {
        const finalGuide = new fabric.Line([guideLine.x1, guideLine.y1, guideLine.x2, guideLine.y2], {
            stroke: guideLine.stroke, strokeWidth: guideLine.strokeWidth, strokeDashArray: guideLine.strokeDashArray,
            selectable: false, evented: false, isGuide: true, level: state.currentLevel, strokeUniform: true,
        });
        
        state.guideLines.push(finalGuide);
        state.canvas.add(finalGuide);
        exitAllModes();
        return;
    }
    if (state.currentMode === 'drawingParking' && parkingLine) {
        generateLinearParking(parkingStartPoint, state.canvas.getPointer(o.e));
        exitAllModes();
    }
    clearEdgeSnapIndicator();
}
export function  handleAfterRender() {
    clearOverlay();
    
    const layoutToDraw = state.livePreviewLayout || state.currentApartmentLayout;
    if (layoutToDraw) {
        redrawApartmentPreview(layoutToDraw);
    }

    if (state.liveDimensionLine) {
        drawLiveDimension(state.liveDimensionLine.p1, state.liveDimensionLine.p2);
    }

    if (isMeasuring && measurePoint1 && state.lastMousePointer) {
        const snapPoint = findSnapPoint(state.lastMousePointer);
        const endPoint = snapPoint ? snapPoint : state.lastMousePointer;
        drawMeasurement(getOverlayContext(), measurePoint1, endPoint);
    }
}
export function  handleObjectModified(e) {
    const target = e.target;
    if (!target) return;
        recordAction('OBJECT_MODIFIED', { 
        object: target.toObject(['blockId', 'level', 'isFootprint']),
        transform: target.calcTransformMatrix()
    });
    clearEdgeSnapIndicator();
    if (target.isServiceBlock || target.isCompositeGroup) renderServiceBlockList();
    if (target.isParkingRow){ updateParkingDisplay(); }
    if (target.isFootprint) {
        updateLevelFootprintInfo();
    }
    if (target.isFootprint && state.currentLevel === 'Typical_Floor' && state.projectType === 'Residential' && state.currentProgram) {
        const program = state.currentProgram;
        
        let tempPerimeter = 0;
        const props = getPolygonProperties(target);

        if (target.isLinearFootprint) {
            // A linear footprint is a thin polygon. Its "length" is roughly half its perimeter.
            tempPerimeter = props.perimeter / 2;
        } else {
            // A standard closed footprint or a polyline (during drawing). Use its perimeter/length directly.
            tempPerimeter = props.perimeter;
        }

        const totalMix = program.unitTypes.reduce((sum, unit) => sum + unit.mix, 0) || 1;
        const avgFrontage = program.unitTypes.reduce((acc, unit) => acc + (unit.frontage * (unit.mix / totalMix)), 0);
        if (avgFrontage > 0) {
            const calcMode = document.getElementById('apartment-calc-mode').value;
            const balconyPlacement = document.getElementById('balcony-placement').value;
            const includeBalconiesInOffset = balconyPlacement === 'recessed';
            const doubleLoaded = document.getElementById('double-loaded-corridor').checked;

            const estimatedUnits = Math.floor(tempPerimeter / avgFrontage);
            const counts = allocateCountsByPercent(estimatedUnits, program.unitTypes);
            state.livePreviewLayout = layoutFlatsOnPolygon(target, counts, includeBalconiesInOffset, calcMode, doubleLoaded);
            updateParkingDisplay(counts);
        }
    }
    updateSelectedObjectControls(target);
    state.canvas.requestRenderAll();
}
export function  handleObjectMoving(e) {
    if (e.target.isVertex) return;
    if (document.getElementById('snap-auto-align').checked) { snapObjectToEdge(e.target); } 
    else { clearEdgeSnapIndicator(); }
}
export function  handleObjectScaling(e) {
    if (e.target?.isParkingRow) { regenerateParkingInGroup(e.target, state.scale.ratio); updateParkingDisplay(); }
    if (e.target?.isFootprint) { updateLevelFootprintInfo(); }
}

export function  handleProjectTypeChange(e) {
    state.projectType = e.target.value;
    populateServiceBlocksDropdown();
    const newProgramMaster = PROJECT_PROGRAMS[state.projectType];
    if (newProgramMaster) {
        const newProgramData = JSON.parse(JSON.stringify(newProgramMaster));
        state.currentProgram = rehydrateProgram(newProgramData, newProgramMaster);
    } else { state.currentProgram = null; }
    document.getElementById('hotel-classification-wrapper').style.display = (state.projectType === 'Hotel') ? 'block' : 'none';
    document.getElementById('labour-camp-settings').style.display = (state.projectType === 'LabourCamp') ? 'block' : 'none';
    updateProgramUI();
    updateParkingDisplay();
    updateUI();
}
export function  handleMixerInputChange(e) {
    const input = e.target;
    if (input.classList.contains('mix-input')) {
        const key = input.dataset.key;
        const value = Math.max(0, Math.min(100, parseInt(input.value) || 0));
        const unit = state.currentProgram.unitTypes.find(a => a.key === key);
        if (unit) unit.mix = value;
        document.getElementById(`range-${key}`).value = value;
        document.getElementById(`num-${key}`).value = value;
        updateMixTotal();
    }
}
export function  handleUnitCardClick(e) {
    const card = e.target.closest('.unit-card');
    if (card?.dataset.key) {
        currentlyEditingUnitKey = card.dataset.key;
        openEditUnitModal(card.dataset.key);
    }
}

export function  startAlignment() {
    const selectedObject = state.canvas.getActiveObject();
    if (selectedObject) {
        objectToAlign = selectedObject;
        enterMode('aligningObject');
    }
}
export function  handleEdgeSelection(pointer) {
    const edgeIndex = getClickedPlotEdge(pointer);
    if (edgeIndex === -1) return;
    const selectionIndex = state.selectedPlotEdges.indexOf(edgeIndex);
    if (selectionIndex > -1) state.selectedPlotEdges.splice(selectionIndex, 1);
    else state.selectedPlotEdges.push(edgeIndex);
    updateEdgeHighlight(pointer);
    
    // --- MODIFICATION START: Update UI on edge selection ---
    if (state.selectedPlotEdges.length > 0) {
        const firstEdgeIndex = state.selectedPlotEdges[0];
        const edgeProps = state.plotEdgeProperties[firstEdgeIndex];
        if (edgeProps) {
            document.getElementById('individual-setback-dist').value = edgeProps.distance;
            document.getElementById('individual-setback-dir').value = edgeProps.direction;
            const typeRadio = document.getElementById(`edge-type-${edgeProps.type}`);
            if (typeRadio) typeRadio.checked = true;
        }
    }
    // --- MODIFICATION END ---
}
export function  applyIndividualSetbacks() {
    const distance= parseFloat(document.getElementById('individual-setback-dist').value);
    const direction = document.getElementById('individual-setback-dir').value;
    // --- MODIFICATION START: Read edge type ---
    const edgeType = document.querySelector('input[name="edge-type"]:checked').value;
    // --- MODIFICATION END ---

    if (isNaN(distance) || state.selectedPlotEdges.length === 0) {
        document.getElementById('status-bar').textContent = "Please select one or more plot edges and enter a valid distance.";
        return;
    }

    // --- MODIFICATION START: Disable auto-setbacks on manual change ---
    const autoToggle = document.getElementById('auto-setback-toggle');
    if (autoToggle.checked) {
        autoToggle.checked = false;
        document.getElementById('status-bar').textContent = "Auto-setbacks disabled due to manual override.";
    }
    // --- MODIFICATION END ---

    state.selectedPlotEdges.forEach(index => { 
        state.plotEdgeProperties[index] = { distance, direction, type: edgeType }; // Save type
    });

    drawSetbackGuides();
}
export function  clearSetbackSelection() {
    state.selectedPlotEdges = [];
    clearEdgeHighlight();
}
function enterGroupEditMode() {
    const group = state.canvas.getActiveObject();
    if (!group || !group.isCompositeGroup) return;

    window.isEditingGroup = true;
    window.groupBeingEdited = group; // Store the original group
    
    // Explode the group into an active selection of its children
    group.toActiveSelection();
    // Discard the active selection to make items individually selectable
    state.canvas.discardActiveObject();
    
    state.canvas.renderAll();
    updateUI();
    updateSelectedObjectControls(null);
}
function exitGroupEditMode() {
    if (!window.isEditingGroup || !window.groupBeingEdited) return;

    const originalGroup = window.groupBeingEdited;
    
    // Filter to get only the items that were part of the group AND are still on canvas
    const originalItems = originalGroup.getObjects();
    const itemsToGroup = originalItems.filter(item => state.canvas.getObjects().includes(item));


    // Remove the individual items from the canvas before re-grouping
    itemsToGroup.forEach(item => state.canvas.remove(item));

    // Create a new group from the (potentially modified) items
    const newGroup = new fabric.Group(itemsToGroup, {
        left: originalGroup.left,
        top: originalGroup.top,
        angle: originalGroup.angle,
        originX: 'center',
        originY: 'center',
        level: originalGroup.level,
        isCompositeGroup: true
    });

    // Clean up and add the new group
    state.canvas.add(newGroup);
    window.isEditingGroup = false;
    window.groupBeingEdited = null;
    
    state.canvas.setActiveObject(newGroup);
    state.canvas.renderAll();
    updateUI();
}
// NEW: Handle category change for selected block/group
export function handleCategoryChange(e) {
    const newCategory = e.target.value;
    const activeObject = state.canvas.getActiveObject();
    if (!activeObject || !(activeObject.isServiceBlock || activeObject.isCompositeGroup)) return;

    const colors = BLOCK_CATEGORY_COLORS[newCategory];
    if (!colors) return;

    const updateObjectCategory = (obj) => {
        if (obj.blockData) {
            obj.blockData.category = newCategory;
        }
        const rect = obj._objects ? obj._objects[0] : null; // Access rect inside group
        if (rect) {
            rect.set({ fill: colors.fill, stroke: colors.stroke });
        }
    };

    if (activeObject.isCompositeGroup) {
        activeObject.forEachObject(subObj => {
            updateObjectCategory(subObj);
        });
    } else { // isServiceBlock
        updateObjectCategory(activeObject);
    }
    
    recordAction('CHANGE_CATEGORY', { objectId: activeObject.blockId, newCategory });
    state.canvas.renderAll();
    renderServiceBlockList();
    handleCalculate(true); // Recalculate areas
}


// NEW: Handlers for editable area statement
function saveAreaStatementChanges() {
    const form = document.getElementById('area-statement-form');
    form.querySelectorAll('input[type="number"]').forEach(input => {
        const { level, type } = input.dataset;
        const value = parseFloat(input.value);
        if (!isNaN(value)) {
            if (!state.manualAreaOverrides[level]) {
                state.manualAreaOverrides[level] = {};
            }
            state.manualAreaOverrides[level][type] = value;
        }
    });
    recordAction('SAVE_AREA_OVERRIDES', { overrides: state.manualAreaOverrides });
    document.getElementById('area-statement-modal').style.display = 'none';
    handleCalculate(true); // Force a live update of the report
}

function resetAreaOverrides() {
    if (confirm('Are you sure you want to remove all manual area overrides?')) {
        state.manualAreaOverrides = {};
        recordAction('RESET_AREA_OVERRIDES', {});
        openAreaStatementModal(); // Re-open/refresh the modal to show calculated values
        handleCalculate(true);
    }
}

function addManualAreaEntry() {
    const level = document.getElementById('manual-area-level').value;
    const type = document.getElementById('manual-area-type').value;
    const value = parseFloat(document.getElementById('manual-area-value').value);

    if (level && type && !isNaN(value)) {
        if (!state.manualAreaOverrides[level]) {
            state.manualAreaOverrides[level] = {};
        }
       if (type === 'corridor') {
            // Add to the commonGfa override, creating it if it doesn't exist.
            const existingCommon = state.manualAreaOverrides[level].commonGfa || 0;
            state.manualAreaOverrides[level].commonGfa = existingCommon + value;
        } else {
            state.manualAreaOverrides[level][type] = value;
        }
        openAreaStatementModal(); // Refresh modal to show the new entry
    } else {
        alert('Please fill all fields for the manual entry.');
    }
}

export function alignCoreElements() {
    const referenceLevel = 'Typical_Floor';
    
    const getCoreBlocks = (level) => {
        return state.serviceBlocks.filter(b => 
            b.level === level && 
            b.blockData && 
            (b.blockData.name.toLowerCase().includes('lift') || b.blockData.role === 'staircase')
        );
    };

    const calculateCentroid = (blocks) => {
        if (!blocks || blocks.length === 0) return null;
        const center = blocks.reduce((acc, block) => {
            const blockCenter = block.getCenterPoint();
            acc.x += blockCenter.x;
            acc.y += blockCenter.y;
            return acc;
        }, { x: 0, y: 0 });
        
        center.x /= blocks.length;
        center.y /= blocks.length;
        return center;
    };

    const referenceCoreBlocks = getCoreBlocks(referenceLevel);
    if (referenceCoreBlocks.length === 0) {
        document.getElementById('status-bar').textContent = `No core elements (lifts/stairs) found on the reference level '${referenceLevel.replace(/_/g, ' ')}' to align to.`;
        return;
    }
    
    const referenceCentroid = calculateCentroid(referenceCoreBlocks);

    let alignedLevels = 0;
    LEVEL_ORDER.forEach(levelKey => {
        if (levelKey === referenceLevel) return;

        const levelCoreBlocks = getCoreBlocks(levelKey);
        if (levelCoreBlocks.length === 0) return;

        const levelCentroid = calculateCentroid(levelCoreBlocks);
        if (!levelCentroid) return;

        const dx = referenceCentroid.x - levelCentroid.x;
        const dy = referenceCentroid.y - levelCentroid.y;

        if (Math.abs(dx) < 0.1 && Math.abs(dy) < 0.1) return; // Already aligned, skip

        levelCoreBlocks.forEach(block => {
            block.set({
                left: block.left + dx,
                top: block.top + dy
            });
            block.setCoords();
        });
        alignedLevels++;
    });

    if (alignedLevels > 0) {
        state.canvas.renderAll();
        recordAction('ALIGN_CORE', { referenceLevel });
        document.getElementById('status-bar').textContent = `Successfully aligned cores on ${alignedLevels} level(s).`;
    } else {
        document.getElementById('status-bar').textContent = 'All cores are already aligned.';
    }
}
// --- Mode Entry/Exit ---
export function enterMode(mode, data = null) {
    if (state.currentMode === 'editingFootprint') {
        confirmFootprintEdit();
    }
    exitAllModes();
    setCurrentMode(mode);
    state.canvas.selection = false;
    state.canvas.discardActiveObject().renderAll();

    if ((mode === 'drawingBuilding' || mode === 'drawingLinearBuilding' || mode === 'drawingCorridor') && state.plotPolygon) drawSetbackGuides();
    if (mode === 'placingCompositeBlock') selectedCompositeBlockData = data;
     if (mode === 'drawingParkingOnEdge') {
        document.getElementById('status-bar').textContent = 'Select a building edge on a valid level (Basement, Ground, Podium) to place parking.';
    }
    if (mode === 'editingSetback') document.getElementById('individual-setback-controls').style.display = 'block';
    if (mode === 'editingFootprint') {
        const selected = state.canvas.getActiveObject();
        const footprintToEdit = (selected && selected.isFootprint) ? selected : state.levels[state.currentLevel]?.objects.find(o => o.isFootprint);
        
        if (footprintToEdit) {
            makeFootprintEditable(footprintToEdit);
            state.canvas.setActiveObject(footprintToEdit);
            state.canvas.renderAll();
        } else {
            document.getElementById('status-bar').textContent = 'No footprint on this level to edit. Please select one or draw one.';
            exitAllModes();
        }
    }
    if (mode === 'aligningObject') {
        if (objectToAlign) objectToAlign.set({ evented: false });
        state.canvas.hoverCursor = 'move';
    }
    if (mode === 'measuring') {
        isMeasuring = true;
        measurePoint1 = null;
        state.canvas.selection = false;
        state.canvas.hoverCursor = 'crosshair';
        document.getElementById('status-bar').textContent = 'Mode: Measure. Click start point.';
        document.getElementById('measure-tool-btn').classList.add('active');
        document.getElementById('measure-tool-btn').textContent = 'Cancel Measure';
    }

    if (!['measuring', 'editingFootprint'].includes(mode)) {
        state.canvas.selection = true;
    }
    updateUI();
}

export function exitAllModes() {
    if (state.currentMode === 'editingFootprint') {
        const activeObject = state.canvas.getActiveObject();
        if (activeObject && activeObject.isFootprint) {
            makeFootprintUneditable(activeObject);
        }
    }
    if (state.currentMode === 'measuring') {
       isMeasuring = false;
       measurePoint1 = null;
       clearOverlay();
       document.getElementById('measure-tool-btn').classList.remove('active');
       document.getElementById('measure-tool-btn').textContent = 'Measure Distance';
    }

    document.getElementById('individual-setback-controls').style.display = 'none';
    clearSetbackGuides();
    clearEdgeHighlight();
    state.selectedPlotEdges = [];
    updateAlignmentHighlight(null);
    resetDrawingState();
    if (objectToAlign) {
        objectToAlign.set({ evented: true, selectable: true });
        objectToAlign = null;
    }
    state.canvas.hoverCursor = 'move';
    if (parkingLine) state.canvas.remove(parkingLine);
    parkingLine = null;
    parkingStartPoint = null;
    state.livePreviewLayout = null;
    scalePoint1 = null;
    setCurrentMode(null);
    selectedCompositeBlockData = null;
    state.canvas.selection = true;
    updateUI();
    state.canvas.requestRenderAll();
}

export function  confirmFootprintEdit() {
    const activeObject = state.canvas.getActiveObject();
    if (activeObject && activeObject.isFootprint) { makeFootprintUneditable(activeObject); }
    state.canvas.discardActiveObject().renderAll();
    exitAllModes();
}

export function  handleFinishPolygon(shape, modeOverride = null) {
    let finalShape = shape;
    const currentMode = modeOverride || state.currentMode;
    const isLinearFootprint = currentMode === 'drawingLinearBuilding';
    const isCorridor = currentMode === 'drawingCorridor';
    
    if (isLinearFootprint || isCorridor) {
        let thickness;
        if (isLinearFootprint) {
            const avgUnitDepth = state.currentProgram?.unitTypes.reduce((acc, u) => acc + u.depth, 0) / state.currentProgram.unitTypes.length || 14;
            thickness = (avgUnitDepth / state.scale.ratio);
        } else { // isCorridor
            const widthMeters = parseFloat(document.getElementById('corridor-width-input').value) || 1.8;
            thickness = widthMeters / state.scale.ratio;
        }
        const polyPoints = getPolygonFromPolyline(shape.points, thickness);
        finalShape = new fabric.Polygon(polyPoints, { selectable: false, evented: false, objectCaching: false });
    }

    // For linear footprints, we want to immediately trigger the preview
    if (isLinearFootprint && state.livePreviewLayout) {
        state.currentApartmentLayout = state.livePreviewLayout;
    }
    state.livePreviewLayout = null;

    recordAction('FINISH_POLYGON', { shape: finalShape.toObject(), mode: currentMode, level: state.currentLevel });

    if (currentMode === 'drawingPlot') {
        if (state.plotPolygon) state.canvas.remove(state.plotPolygon);
        state.plotPolygon = finalShape;
        finalShape.set({ fill: 'rgba(0, 0, 255, 0.1)', stroke: 'rgba(0, 0, 255, 0.6)', strokeWidth: 1.5, level: 'Plot', selectable: false, evented: false, isPlot: true, strokeUniform: true });
        // --- MODIFICATION START: Add default 'type' property ---
        state.plotEdgeProperties = finalShape.points.map(() => ({ distance: 5, direction: 'inside', type: 'neighbor' }));
        calculateAndApplySetbacks(); // Apply auto-setbacks immediately
        // --- MODIFICATION END ---
    } else if (currentMode === 'drawingBuilding' || isLinearFootprint || isCorridor) {
        const levelData = state.levels[state.currentLevel];
        const footprintProps = {
           fill: isCorridor ? 'rgba(139, 69, 19, 0.4)' : levelData.color,
            stroke: isCorridor ? '#8B4513' : 'red',
            level: state.currentLevel,
            selectable: false,
            evented: true,
            isFootprint: true,
            strokeUniform: true,
             isLinearFootprint: isLinearFootprint, // Add the flag here
            isCorridorFootprint: isCorridor
        };
        finalShape.set(footprintProps);
        levelData.objects.push(finalShape);
        updateLevelFootprintInfo();
        
        if (finalShape.type === 'polygon' && document.getElementById('auto-place-core-check').checked) {
            const coreForLevel = state.userCompositeBlocks.find(core => core.level === state.currentLevel || core.name.toLowerCase().includes(state.currentLevel.toLowerCase().replace('_', ' ')));
            if (coreForLevel) {
                const coreIndex = state.userCompositeBlocks.indexOf(coreForLevel);
                document.getElementById('composite-block-select').value = coreIndex;
                createCompositeGroup(coreForLevel, finalShape.getCenterPoint());
            } else {
                const selectedIndex = document.getElementById('composite-block-select').value;
                const selectedData = state.userCompositeBlocks[selectedIndex];
                if (selectedData) { createCompositeGroup(selectedData, finalShape.getCenterPoint()); }
            }
        }
    }
    state.canvas.add(finalShape);
    
    if (isLinearFootprint) {
        document.getElementById('previewLayoutBtn').classList.add('active');
        document.getElementById('previewLayoutBtn').textContent = 'Hide Preview';
        state.canvas.requestRenderAll();
        exitAllModes(); 
    } else {
        state.canvas.renderAll();
        exitAllModes();
    }
}
export function  handleFinishPolyline(shape, modeOverride = null) {
    let finalShape = shape;
    const currentMode = modeOverride || state.currentMode;
    const isLinearFootprint = currentMode === 'drawingLinearBuilding';
    
   /*  if (isLinearFootprint) {
        const avgUnitDepth = state.currentProgram?.unitTypes.reduce((acc, u) => acc + u.depth, 0) / state.currentProgram.unitTypes.length || 14;
        const thickness = (avgUnitDepth / state.scale.ratio);
        const polyPoints = getPolygonFromPolyline(shape.points, thickness);
        finalShape = new fabric.Polyline(polyPoints, { selectable: false, evented: false, objectCaching: false });
    } */

    // For linear footprints, we want to immediately trigger the preview
    if (isLinearFootprint && state.livePreviewLayout) {
        state.currentApartmentLayout = state.livePreviewLayout;
    }
    state.livePreviewLayout = null;

    recordAction('FINISH_POLYLINE', { shape: finalShape.toObject(), mode: currentMode, level: state.currentLevel });

    if (currentMode === 'drawingPlot') {
        if (state.plotPolygon) state.canvas.remove(state.plotPolygon);
        state.plotPolygon = finalShape;
        finalShape.set({ fill: 'rgba(0, 0, 255, 0.1)', stroke: 'rgba(0, 0, 255, 0.6)', strokeWidth: 1.5, level: 'Plot', selectable: false, evented: false, isPlot: true, strokeUniform: true });
        state.plotEdgeProperties = finalShape.points.map(() => ({ distance: 5, direction: 'inside' }));
    } else if (currentMode === 'drawingBuilding' || isLinearFootprint) {
        const levelData = state.levels[state.currentLevel];
        const footprintProps = {
            fill: levelData.color,
            stroke: 'red',
            level: state.currentLevel,
            selectable: false,
            evented: true,
            isFootprint: true,
            strokeUniform: true,
            isLinearFootprint: isLinearFootprint // Add the flag here
        };
        finalShape.set(footprintProps);
        levelData.objects.push(finalShape);
        updateLevelFootprintInfo();
        
        if (finalShape.type === 'polygon' && document.getElementById('auto-place-core-check').checked) {
            const coreForLevel = state.userCompositeBlocks.find(core => core.level === state.currentLevel || core.name.toLowerCase().includes(state.currentLevel.toLowerCase().replace('_', ' ')));
            if (coreForLevel) {
                const coreIndex = state.userCompositeBlocks.indexOf(coreForLevel);
                document.getElementById('composite-block-select').value = coreIndex;
                createCompositeGroup(coreForLevel, finalShape.getCenterPoint());
            } else {
                const selectedIndex = document.getElementById('composite-block-select').value;
                const selectedData = state.userCompositeBlocks[selectedIndex];
                if (selectedData) { createCompositeGroup(selectedData, finalShape.getCenterPoint()); }
            }
        }
    }
    state.canvas.add(finalShape);
    
    if (isLinearFootprint) {
        document.getElementById('previewLayoutBtn').classList.add('active');
        document.getElementById('previewLayoutBtn').textContent = 'Hide Preview';
        state.canvas.requestRenderAll();
        exitAllModes(); 
    } else {
        state.canvas.renderAll();
        exitAllModes();
    }
}
```